{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrahead %}
    {{ block.super }}
    <style>
        .stats-container {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        .stat-item {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.25rem;
            padding: 0.75rem;
            text-align: center;
        }
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #0066cc;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }
        .category-stats, .brand-stats, .ownership-stats {
            margin-top: 1rem;
        }
        .category-stat-item, .brand-stat-item, .ownership-stat-item {
            display: inline-block;
            background: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            margin: 0.25rem;
            font-size: 0.875rem;
        }
        .ownership-our {
            background: #d4edda;
            border-color: #c3e6cb;
        }
        .ownership-competitor {
            background: #f8d7da;
            border-color: #f5c6cb;
        }
    </style>
{% endblock %}

{% block content_title %}
    <h1>仪器调研管理</h1>
    
    {% if total_instruments %}
    <div class="stats-container">
        <!-- 基础统计网格 -->
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">{{ total_instruments }}</div>
                <div class="stat-label">仪器记录总数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ total_quantity }}</div>
                <div class="stat-label">设备总台数</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ total_sample_volume }}</div>
                <div class="stat-label">总标本量</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ this_week_count }}</div>
                <div class="stat-label">本周更新</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ this_month_count }}</div>
                <div class="stat-label">本月更新</div>
            </div>
        </div>
        
        <!-- 标本量详细分布（样式和分类统计一致） -->
        <div class="category-stats">
            <strong>📊 标本量分布：</strong>
            <span class="category-stat-item">血球仪器: {{ blood_sample_volume }} 例</span>
            <span class="category-stat-item">糖化仪器: {{ glycation_sample_volume }} 例</span>
            <span class="category-stat-item">尿液仪器: {{ urine_sample_volume }} 例</span>
        </div>
        
        <!-- 仪器分类统计（血球在前） -->
        {% if category_stats %}
        <div class="category-stats">
            <strong>🔬 分类统计：</strong>
            {% for category, stats in category_stats.items %}
                <span class="category-stat-item">{{ category }}: {{ stats.count }}个记录/{{ stats.quantity }}台设备</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- 品牌统计 -->
        {% if brand_stats %}
        <div class="brand-stats">
            <strong>🏷️ 品牌分布 (Top5)：</strong>
            {% for brand in brand_stats %}
                <span class="brand-stat-item">{{ brand.brand__brand }}: {{ brand.count }}个/{{ brand.total_quantity }}台</span>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- 我司vs竞品统计 -->
        <div class="ownership-stats">
            <strong>🏢 设备归属：</strong>
            <span class="ownership-stat-item ownership-our">我司设备: {{ our_stats.count }}个记录 ({{ our_stats.quantity }}台, {{ our_percentage }}%)</span>
            <span class="ownership-stat-item ownership-competitor">竞品设备: {{ competitor_stats.count }}个记录 ({{ competitor_stats.quantity }}台)</span>
        </div>
        
        <!-- 装机年份分布 -->
        {% if year_stats %}
        <div class="category-stats">
            <strong>📅 装机年份分布：</strong>
            {% for year, count in year_stats.items %}
                <span class="category-stat-item">{{ year }}年: {{ count }}台</span>
            {% endfor %}
        </div>
        {% endif %}
    </div>
    {% endif %}
{% endblock %}

{% block content %}
    {{ block.super }}
{% endblock %}