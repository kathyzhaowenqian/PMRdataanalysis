{% extends "admin/change_list.html" %}
{% load i18n admin_urls static admin_list %}

{% block extrahead %}
    {{ block.super }}
    <!-- ä½¿ç”¨ç¨³å®šç‰ˆæœ¬çš„Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <style>

        /* ç¡®ä¿å›¾ä¾‹æ˜¾ç¤ºæ­£å¸¸ */
        .chart-canvas {
            width: 100% !important;
            height: 320px !important;
            max-width: 320px;
            margin: 0 auto;
        }

        /* ç¯å½¢å›¾å®¹å™¨ */
        .doughnut-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 320px;
            position: relative;
        }

        .doughnut-canvas {
            max-width: 280px !important;
            max-height: 280px !important;
            width: 280px !important;
            height: 280px !important;
        }

        /* ç¡®ä¿å›¾ä¾‹ä¸è¢«éšè— */
        canvas {
            display: block !important;
        }

        /* Chart.jså›¾ä¾‹æ ·å¼ä¿®å¤ */
        .chart-item .chartjs-legend {
            display: block !important;
            margin-top: 1rem;
        }

        .chart-item .chartjs-legend ul {
            margin: 0 !important;
            padding: 0 !important;
            list-style: none !important;
        }

        .chart-item .chartjs-legend li {
            display: inline-block !important;
            margin: 0.25rem !important;
            padding: 0.25rem 0.5rem !important;
            font-size: 0.85rem !important;
        }

        /* 111111111111111111111 */

        .chart-subtitle {
            font-size: 1.1rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .stats-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }
        
        .stat-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .stat-item:hover {
            transform: translateY(-5px) scale(1.05);
            background: rgba(255, 255, 255, 0.25);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* å›¾è¡¨å®¹å™¨ */
        .charts-container {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .charts-row-2 {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .chart-item {
            background: #fff;
            border: none;
            border-radius: 16px;
            padding: 2rem;
            min-height: 450px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .chart-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .chart-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }
        
        .chart-title {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1.5rem;
            text-align: center;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        /* ä¿®æ”¹å›¾è¡¨å®¹å™¨æ ·å¼ï¼Œç¡®ä¿ç¯å½¢å›¾æ˜¯æ­£åœ† */
        .chart-canvas {
            width: 100% !important;
            height: 320px !important;
            max-width: 320px;
            margin: 0 auto;
        }
        
        /* ç¯å½¢å›¾ç‰¹æ®Šå¤„ç† */
        .doughnut-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 320px;
        }
        
        .doughnut-canvas {
            max-width: 280px !important;
            max-height: 280px !important;
            width: 280px !important;
            height: 280px !important;
        }
        
        /* TOPåŒ»é™¢æ’åæ ·å¼ - ä¼˜åŒ–æ¡Œé¢ç«¯å¯¹é½ */
        .ranking-list {
            margin-top: 1rem;
            max-height: 380px;
            overflow-y: auto;
        }
        
        .ranking-item {
            display: flex;
            align-items: center;
            padding: 1rem 1.2rem;
            margin-bottom: 0.8rem;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            border: none;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            position: relative;
            overflow: hidden;
            min-height: 50px;
        }
        
        .ranking-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(135deg, #667eea, #764ba2);
        }
        
        .ranking-item:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
            transform: translateX(6px) scale(1.01);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .ranking-item:nth-child(1)::before { background: linear-gradient(135deg, #ffd700, #ffed4e); }
        .ranking-item:nth-child(2)::before { background: linear-gradient(135deg, #c0c0c0, #e5e5e5); }
        .ranking-item:nth-child(3)::before { background: linear-gradient(135deg, #cd7f32, #deb887); }
        
        /* æ¡Œé¢ç«¯æ’åæ•°å­— - å›ºå®šå®½åº¦ï¼Œå±…ä¸­å¯¹é½ */
        .ranking-number {
            font-weight: 700;
            color: #667eea;
            width: 35px;
            text-align: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }
        
        /* æ¡Œé¢ç«¯åŒ»é™¢åç§° - å·¦å¯¹é½ï¼Œå æ®å‰©ä½™ç©ºé—´ */
        .ranking-hospital {
            flex: 1;
            font-weight: 600;
            color: #333;
            font-size: 1rem;
            line-height: 1.4;
            text-align: left;
            padding: 0 1rem;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        /* æ¡Œé¢ç«¯åœ°åŒº - å›ºå®šå®½åº¦ï¼Œå±…ä¸­å¯¹é½ */
        .ranking-district {
            color: #6c757d;
            font-size: 0.85rem;
            font-style: italic;
            width: 90px;
            text-align: center;
            flex-shrink: 0;
        }
      
        /* æ¡Œé¢ç«¯æ•°é‡ - å›ºå®šå®½åº¦ï¼Œå±…ä¸­å¯¹é½ */
        .ranking-count {
            color: #667eea;
            font-weight: 700;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 1rem;
            width: 70px;
            text-align: center;
            flex-shrink: 0;
        }
        
        /* å®¢æƒ…ç»Ÿè®¡æ ·å¼ */
        .familiarity-stats {
            background: #fff;
            border: none;
            border-radius: 16px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            min-height: 450px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .familiarity-stats::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }
        
        .familiarity-stat-item {
            display: inline-block;
            padding: 0.5rem 1rem;
            margin: 0.25rem;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .familiarity-red {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .familiarity-yellow {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .familiarity-green {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .familiarity-blue {
            background: #cce5ff;
            color: #004085;
            border: 1px solid #99ccff;
        }
        
        /* éšè—æ‰‹æœºç‰ˆå¸ƒå±€å…ƒç´ ï¼ˆæ¡Œé¢ç«¯ï¼‰ */
        .ranking-main,
        .ranking-meta {
            display: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .charts-container {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }
            
            .charts-row-2 {
                grid-template-columns: 1fr;
            }
        }
        
        /* @media (max-width: 768px) { */
            /* éšè—æ¡Œé¢ç‰ˆå…ƒç´  */
            /* .ranking-item > .ranking-number,
            .ranking-item > .ranking-hospital,
            .ranking-item > .ranking-district,
            .ranking-item > .ranking-count {
                display: none;
            } */
            
            /* æ˜¾ç¤ºæ‰‹æœºç‰ˆå¸ƒå±€ */
            /* .ranking-main,
            .ranking-meta {
                display: flex !important;
            }
            
            .ranking-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                min-height: auto;
                gap: 0.5rem;
            }
            
            .ranking-main {
                align-items: flex-start;
                width: 100%;
                gap: 1rem;
            }
            
            .ranking-main .ranking-number {
                width: 25px;
                font-size: 1.2rem;
                text-align: left;
                flex-shrink: 0;
            }
            
            .ranking-main .ranking-hospital {
                flex: 1;
                font-size: 1.05rem;
                line-height: 1.3;
                word-break: break-word;
                hyphens: auto;
                padding: 0;
                text-align: left;
            }
            
            .ranking-meta {
                justify-content: space-between;
                align-items: center;
                width: 100%;
                margin-left: 35px;
            }
            
            .ranking-meta .ranking-district {
                width: auto;
                flex: 1;
                font-size: 0.9rem;
                text-align: left;
            }
            
            .ranking-meta .ranking-count {
                width: 55px;
                padding: 0.4rem 0.8rem;
                font-size: 0.95rem;
            }
        } */

        @media (max-width: 768px) {
            /* éšè—æ¡Œé¢ç‰ˆå…ƒç´  */
            .ranking-item > .ranking-number,
            .ranking-item > .ranking-hospital,
            .ranking-item > .ranking-district,
            .ranking-item > .ranking-count {
                display: none;
            }
            
            /* æ˜¾ç¤ºæ‰‹æœºç‰ˆå¸ƒå±€ */
            .ranking-main,
            .ranking-meta {
                display: flex !important;
            }
            
            .ranking-item {
                flex-direction: column;
                align-items: flex-start;
                padding: 1rem;
                min-height: auto;
                gap: 0.5rem;
            }
            
            .ranking-main {
                align-items: flex-start;
                width: 100%;
                gap: 1rem;
            }
            
            .ranking-main .ranking-number {
                width: 25px;
                font-size: 1.2rem;
                text-align: left;
                flex-shrink: 0;
            }
            
            .ranking-main .ranking-hospital {
                flex: 1;
                font-size: 1.05rem;
                line-height: 1.3;
                word-break: break-word;
                hyphens: auto;
                padding: 0;
                text-align: left;
            }
            
            .ranking-meta {
                /* ä¿®å¤ï¼šé‡æ–°è®¾è®¡å¸ƒå±€ */
                width: calc(100% - 35px); /* ç¡®ä¿ä¸è¶…å‡ºå®¹å™¨ */
                margin-left: 35px;
                display: flex;
                align-items: center;
                gap: 1rem; /* å›ºå®šé—´è·ï¼Œä¸è¦ç”¨space-between */
            }
            
            .ranking-meta .ranking-district {
                font-size: 0.9rem;
                color: #6c757d;
                /* ä¿®å¤ï¼šè®¾ç½®å›ºå®šçš„flexæ¯”ä¾‹ */
                flex: 0 1 auto; /* ä¸æ‰©å±•ï¼Œä½†å¯ä»¥æ”¶ç¼© */
                max-width: 120px; /* é™åˆ¶æœ€å¤§å®½åº¦ */
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap; /* è¶…å‡ºæ—¶æ˜¾ç¤ºçœç•¥å· */
                text-align: left;
            }
            
            .ranking-meta .ranking-count {
                /* ä¿®å¤ï¼šè®¾ç½®ä¸ºå›ºå®šå®½åº¦ï¼Œä¸å‚ä¸flex */
                flex: none; /* ä¸å‚ä¸flexå¸ƒå±€ */
                width: 70px; /* å›ºå®šå®½åº¦ */
                padding: 0.4rem 0.6rem;
                font-size: 0.95rem;
                background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
                border-radius: 8px;
                color: #667eea;
                font-weight: 700;
                text-align: center;
                white-space: nowrap;
            }
        }

    .familiarity-stat-item.familiarity-gray {
        background-color: #f5f5f5;
        color: #666;
        border-color: #ccc;
    }
        
    </style>
{% endblock %}

{% block content_title %}
    <h1 style="background: linear-gradient(135deg, #667eea, #764ba2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 800;">
        ğŸ¥ åŒ»é™¢è°ƒç ”ç®¡ç†
    </h1>
    
    <div class="stats-container">
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-number">{{ total_hospitals }}</div>
                <div class="stat-label">åŒ»é™¢æ€»æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ total_all_samples }}</div>
                <div class="stat-label">æ€»æ ‡æœ¬é‡</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ total_all_instruments }}</div>
                <div class="stat-label">æ€»è®¾å¤‡å°æ•°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ this_week_count }}</div>
                <div class="stat-label">æœ¬å‘¨æ›´æ–°</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">{{ this_month_count }}</div>
                <div class="stat-label">æœ¬æœˆæ›´æ–°</div>
            </div>
        </div>
        
        <!-- ç¬¬ä¸€æ’å›¾è¡¨ï¼šä¸¤ä¸ªç¯å½¢å›¾ + å®¢æƒ…ç»Ÿè®¡ -->
        <div class="charts-container">
            <!-- 1. æ ‡æœ¬é‡åˆ†å¸ƒç¯å½¢å›¾ -->
            <div class="chart-item">
                <div class="chart-title">ğŸ§ª æ ‡æœ¬é‡åˆ†å¸ƒ</div>
                <div class="doughnut-container">
                    <canvas id="volumeChart" class="doughnut-canvas"></canvas>
                </div>
            </div>
            
            <!-- 2. ä»ªå™¨å°æ•°åˆ†å¸ƒç¯å½¢å›¾ -->
            <div class="chart-item">
                <div class="chart-title">ğŸ”¬ ä»ªå™¨å°æ•°åˆ†å¸ƒ</div>
                <div class="doughnut-container">
                    <canvas id="instrumentChart" class="doughnut-canvas"></canvas>
                </div>
            </div>
            
          
            <!-- 3. å®¢æƒ…ç»Ÿè®¡ -->
            <!-- {% if director_familiarity_stats or leader_familiarity_stats %}
            <div class="familiarity-stats">
                <div class="chart-title">ğŸ‘¥ å®¢æƒ…ç»Ÿè®¡</div>
                <div style="margin-bottom: 1.5rem;">
                    <div class="chart-subtitle">ä¸»ä»»å®¢æƒ…ï¼š</div>
                    <div style="margin-top: 0.5rem;">
                        {% for familiarity, count in director_familiarity_stats.items %}
                            <span class="familiarity-stat-item familiarity-{% if familiarity == 'ä¸è®¤è¯†' %}red{% elif familiarity == 'æœ‰å•†æœºåœ¨è·Ÿè¿›' %}yellow{% elif familiarity == 'æœ‰æ˜ç¡®ä»£ç†å•†' %}green{% elif familiarity == 'æˆå•' %}blue{% endif %}">
                                {{ familiarity }}: {{ count }}ä¸ª
                            </span>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <div class="chart-subtitle">ç»„é•¿å®¢æƒ…ï¼š</div>
                    <div style="margin-top: 0.5rem;">
                        {% for familiarity, count in leader_familiarity_stats.items %}
                            <span class="familiarity-stat-item familiarity-{% if familiarity == 'ä¸è®¤è¯†' %}red{% elif familiarity == 'æœ‰å•†æœºåœ¨è·Ÿè¿›' %}yellow{% elif familiarity == 'æœ‰æ˜ç¡®ä»£ç†å•†' %}green{% elif familiarity == 'æˆå•' %}blue{% endif %}">
                                {{ familiarity }}: {{ count }}ä¸ª
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %} -->
            <!-- 3. å®¢æƒ…ç»Ÿè®¡ -->
            {% if director_familiarity_stats or leader_familiarity_stats %}
            <div class="familiarity-stats">
                <div class="chart-title">ğŸ‘¥ å®¢æƒ…ç»Ÿè®¡</div>
                <div style="margin-bottom: 1.5rem;">
                    <div class="chart-subtitle">ä¸»ä»»å®¢æƒ…ï¼š</div>
                    <div style="margin-top: 0.5rem;">
                        {% for familiarity, count in director_familiarity_stats.items %}
                            <span class="familiarity-stat-item familiarity-{% if familiarity == 'ä¸è®¤è¯†' %}red{% elif familiarity == 'æœ‰å•†æœºåœ¨è·Ÿè¿›' %}yellow{% elif familiarity == 'æœ‰æ˜ç¡®ä»£ç†å•†' %}green{% elif familiarity == 'æˆå•' %}blue{% elif familiarity == 'æœªè®¾ç½®' %}gray{% endif %}">
                                {{ familiarity }}: {{ count }}ä¸ª
                            </span>
                        {% endfor %}
                    </div>
                </div>
                <div>
                    <div class="chart-subtitle">ç»„é•¿å®¢æƒ…ï¼š</div>
                    <div style="margin-top: 0.5rem;">
                        {% for familiarity, count in leader_familiarity_stats.items %}
                            <span class="familiarity-stat-item familiarity-{% if familiarity == 'ä¸è®¤è¯†' %}red{% elif familiarity == 'æœ‰å•†æœºåœ¨è·Ÿè¿›' %}yellow{% elif familiarity == 'æœ‰æ˜ç¡®ä»£ç†å•†' %}green{% elif familiarity == 'æˆå•' %}blue{% elif familiarity == 'æœªè®¾ç½®' %}gray{% endif %}">
                                {{ familiarity }}: {{ count }}ä¸ª
                            </span>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- ç¬¬äºŒæ’å›¾è¡¨ï¼šä¸‰ä¸ªæ’ååˆ—è¡¨ -->
        <div class="charts-row-2">
            <!-- 1. åŒ»é™¢æ ‡æœ¬é‡æ’å -->
            <div class="chart-item">
                <div class="chart-title">ğŸ† åŒ»é™¢æ ‡æœ¬é‡æ’å Top15</div>
                <div class="ranking-list">
                    {% for hospital in hospital_sample_rankings %}
                    <div class="ranking-item">
                        <!-- æ¡Œé¢ç‰ˆå¸ƒå±€ -->
                        <span class="ranking-number">{{ hospital.rank }}</span>
                        <span class="ranking-hospital">{{ hospital.hospital_name }}</span>
                        <span class="ranking-district">({{ hospital.district }})</span>
                        <span class="ranking-count">{{ hospital.total_sample }} </span>
                        
                        <!-- æ‰‹æœºç‰ˆå¸ƒå±€ç»“æ„ -->
                        <div class="ranking-main">
                            <span class="ranking-number">{{ hospital.rank }}</span>
                            <span class="ranking-hospital">{{ hospital.hospital_name }}</span>
                        </div>
                        <div class="ranking-meta">
                            <span class="ranking-district">({{ hospital.district }})</span>
                            <span class="ranking-count">{{ hospital.total_sample }} </span>
                        </div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">
                        ğŸ“­ æš‚æ— æ•°æ®
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 2. åŒ»é™¢ä»ªå™¨å°æ•°æ’å -->
            <div class="chart-item">
                <div class="chart-title">ğŸ“Š åŒ»é™¢ä»ªå™¨å°æ•°æ’å Top15</div>
                <div class="ranking-list">
                    {% for hospital in hospital_instrument_rankings %}
                    <div class="ranking-item">
                        <!-- æ¡Œé¢ç‰ˆå¸ƒå±€ -->
                        <span class="ranking-number">{{ hospital.rank }}</span>
                        <span class="ranking-hospital">{{ hospital.hospital_name }}</span>
                        <span class="ranking-district">({{ hospital.district }})</span>
                        <span class="ranking-count">{{ hospital.total_instruments }} å°</span>
                        
                        <!-- æ‰‹æœºç‰ˆå¸ƒå±€ç»“æ„ -->
                        <div class="ranking-main">
                            <span class="ranking-number">{{ hospital.rank }}</span>
                            <span class="ranking-hospital">{{ hospital.hospital_name }}</span>
                        </div>
                        <div class="ranking-meta">
                            <span class="ranking-district">({{ hospital.district }})</span>
                            <span class="ranking-count">{{ hospital.total_instruments }} å°</span>
                        </div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">
                        ğŸ“­ æš‚æ— æ•°æ®
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- 3. åŒ»é™¢å•†æœºæ•°é‡æ’å -->
            <div class="chart-item">
                <div class="chart-title">ğŸ’¼ åŒ»é™¢å•†æœºæ•°é‡æ’å Top15</div>
                <div class="ranking-list">
                    {% for hospital in hospital_opportunity_rankings %}
                    <div class="ranking-item">
                        <!-- æ¡Œé¢ç‰ˆå¸ƒå±€ -->
                        <span class="ranking-number">{{ hospital.rank }}</span>
                        <span class="ranking-hospital">{{ hospital.hospital_name }}</span>
                        <span class="ranking-district">({{ hospital.district }})</span>
                        <span class="ranking-count">{{ hospital.opportunity_count }} ä¸ª</span>
                        
                        <!-- æ‰‹æœºç‰ˆå¸ƒå±€ç»“æ„ -->
                        <div class="ranking-main">
                            <span class="ranking-number">{{ hospital.rank }}</span>
                            <span class="ranking-hospital">{{ hospital.hospital_name }}</span>
                        </div>
                        <div class="ranking-meta">
                            <span class="ranking-district">({{ hospital.district }})</span>
                            <span class="ranking-count">{{ hospital.opportunity_count }} ä¸ª</span>
                        </div>
                    </div>
                    {% empty %}
                    <div style="text-align: center; color: #6c757d; padding: 3rem; font-style: italic;">
                        ğŸ“­ æš‚æ— æ•°æ®
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
   <script>
    // ç­‰å¾…é¡µé¢å®Œå…¨åŠ è½½
    window.addEventListener('load', function() {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–å›¾è¡¨...');
        
        // æ£€æŸ¥Chart.jsæ˜¯å¦åŠ è½½
        if (typeof Chart === 'undefined') {
            console.error('Chart.jsæœªåŠ è½½');
            return;
        }
        
        console.log('Chart.jså·²åŠ è½½ï¼Œç‰ˆæœ¬:', Chart.version);
        
        // ä»Djangoæ¨¡æ¿è·å–æ•°æ®
        var volumeData = {{ volume_chart_data|safe }};
        var volumeLabels = {{ volume_chart_labels|safe }};
        var instrumentData = {{ instrument_chart_data|safe }};
        var instrumentLabels = {{ instrument_chart_labels|safe }};
        
        console.log('è·å–åˆ°çš„æ•°æ®:', { volumeData, volumeLabels, instrumentData, instrumentLabels });
        
    
        const modernColors = [
                '#1E3A8A',  // æ·±è“
                '#3B82F6',  // è“è‰²
                '#06B6D4',  // é’è‰²
                '#8B5CF6',  // ç´«è‰²
                '#7DAEA3',  // è«å…°è¿ªç°ç»¿ï¼ˆæ›¿æ¢ï¼‰
                '#6366F1',  // é›è“
                '#14B8A6',  // é’ç»¿
                '#8B5A2B',  // é‡‘å±æ£•
                '#2C3E50',  // æ·±è“ç°ï¼ˆæ›¿æ¢ï¼‰
                '#6B7280'   // ä¸­ç°
            ];
        // é€šç”¨å›¾è¡¨é…ç½®
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 15,
                        usePointStyle: true,
                        pointStyle: 'circle',
                        font: {
                            family: "'Inter', 'Helvetica Neue', Arial, sans-serif",
                            size: 11,
                            weight: '600'
                        },
                        color: '#2d3748',

                        // ä¿®å¤ï¼šä½¿ç”¨é»˜è®¤çš„å›¾ä¾‹ç”Ÿæˆï¼Œä¸è‡ªå®šä¹‰
                        generateLabels: function(chart) {
                            const data = chart.data;
                            if (data.labels.length && data.datasets.length) {
                                const dataset = data.datasets[0];
                                const total = dataset.data.reduce((a, b) => a + b, 0);
                                
                                return data.labels.map((label, i) => {
                                    const value = dataset.data[i];
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    
                                    return {
                                        text: `${label}: ${value.toLocaleString()} (${percentage}%)`,
                                        fillStyle: dataset.backgroundColor[i],
                                        strokeStyle: '#ffffff',
                                        lineWidth: 2,
                                        pointStyle: 'circle',
                                        hidden: false,
                                        index: i
                                    };
                                });
                            }
                            return [];
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(45, 55, 72, 0.95)',
                    titleColor: '#ffffff',
                    bodyColor: '#ffffff',
                    borderColor: '#667eea',
                    borderWidth: 2,
                    cornerRadius: 12,
                    titleFont: {
                        family: "'Inter', 'Helvetica Neue', Arial, sans-serif",
                        size: 14,
                        weight: '700'
                    },
                    bodyFont: {
                        family: "'Inter', 'Helvetica Neue', Arial, sans-serif",
                        size: 13,
                        weight: '500'
                    }
                }
            },
            cutout: '65%',
            animation: {
                animateScale: true,
                animateRotate: true,
                duration: 1500,
                easing: 'easeOutQuart'
            },
            // æ·»åŠ äº¤äº’é…ç½®ï¼Œä¿®å¤ç‚¹å‡»å˜è‰²é—®é¢˜
            interaction: {
                intersect: false,
                mode: 'index'
            },
            // ç¦ç”¨ç‚¹å‡»é«˜äº®ï¼Œé¿å…é¢œè‰²é—®é¢˜
            elements: {
                arc: {
                    borderWidth: 3,
                    borderColor: '#ffffff',
                    hoverBorderWidth: 5,
                    hoverBorderColor: '#ffffff'
                }
            }
        };
        
        // 1. åˆ›å»ºæ ‡æœ¬é‡åˆ†å¸ƒç¯å½¢å›¾
        var volumeCanvas = document.getElementById('volumeChart');
        if (volumeCanvas && volumeData.some(v => v > 0)) {
            console.log('å¼€å§‹åˆ›å»ºæ ‡æœ¬é‡åˆ†å¸ƒå›¾...');
            try {
                // ç¡®ä¿æ¯ä¸ªæ ‡ç­¾éƒ½æœ‰å¯¹åº”çš„é¢œè‰²
                const volumeColors = volumeLabels.map((_, index) => modernColors[index % modernColors.length]);
                
                console.log('é¢œè‰²åˆ†é…:', volumeLabels.map((label, i) => `${label}: ${volumeColors[i]}`));
                
                var volumeChart = new Chart(volumeCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: volumeLabels,
                        datasets: [{
                            data: volumeData,
                            backgroundColor: volumeColors,
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            hoverBackgroundColor: volumeColors, // ä¿®å¤ï¼šæ‚¬åœæ—¶ä¿æŒåŸè‰²
                            hoverBorderColor: '#ffffff',
                            hoverBorderWidth: 5,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        ...chartOptions,
                        plugins: {
                            ...chartOptions.plugins,
                            tooltip: {
                                ...chartOptions.plugins.tooltip,
                                callbacks: {
                                    title: function(context) {
                                        return 'ğŸ§ª ' + context[0].label;
                                    },
                                    label: function(context) {
                                        var value = context.parsed || 0;
                                        var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        var percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                        return [
                                            `æ ‡æœ¬é‡: ${value.toLocaleString()} ä¾‹`,
                                            `å æ¯”: ${percentage}%`
                                        ];
                                    }
                                }
                            }
                        },
                        // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†ï¼Œé˜²æ­¢å¼‚å¸¸è¡Œä¸º
                        onClick: function(event, elements) {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const label = this.data.labels[element.index];
                                const value = this.data.datasets[0].data[element.index];
                                console.log(`ç‚¹å‡»äº†: ${label}, å€¼: ${value}`);
                                // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ è‡ªå®šä¹‰çš„ç‚¹å‡»å¤„ç†é€»è¾‘
                            }
                        }
                    }
                });
                console.log('æ ‡æœ¬é‡åˆ†å¸ƒå›¾åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('åˆ›å»ºæ ‡æœ¬é‡åˆ†å¸ƒå›¾å¤±è´¥:', error);
            }
        } else {
            console.log('æ ‡æœ¬é‡åˆ†å¸ƒå›¾ï¼šæ— æ•°æ®æˆ–canvasä¸å­˜åœ¨');
        }
        
        // 2. åˆ›å»ºä»ªå™¨å°æ•°åˆ†å¸ƒç¯å½¢å›¾ï¼ˆç±»ä¼¼ä¿®å¤ï¼‰
        var instrumentCanvas = document.getElementById('instrumentChart');
        if (instrumentCanvas && instrumentData.some(v => v > 0)) {
            console.log('å¼€å§‹åˆ›å»ºä»ªå™¨å°æ•°åˆ†å¸ƒå›¾...');
            try {
                const instrumentColors = instrumentLabels.map((_, index) => modernColors[(index + 6) % modernColors.length]);
                
                var instrumentChart = new Chart(instrumentCanvas, {
                    type: 'doughnut',
                    data: {
                        labels: instrumentLabels,
                        datasets: [{
                            data: instrumentData,
                            backgroundColor: instrumentColors,
                            borderColor: '#ffffff',
                            borderWidth: 3,
                            hoverBackgroundColor: instrumentColors, // ä¿®å¤ï¼šæ‚¬åœæ—¶ä¿æŒåŸè‰²
                            hoverBorderColor: '#ffffff',
                            hoverBorderWidth: 5,
                            hoverOffset: 8
                        }]
                    },
                    options: {
                        ...chartOptions,
                        plugins: {
                            ...chartOptions.plugins,
                            tooltip: {
                                ...chartOptions.plugins.tooltip,
                                callbacks: {
                                    title: function(context) {
                                        return 'ğŸ”¬ ' + context[0].label;
                                    },
                                    label: function(context) {
                                        var value = context.parsed || 0;
                                        var total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        var percentage = total > 0 ? ((value / total) * 100).toFixed(2) : 0;
                                        return [
                                            `å°æ•°: ${value} å°`,
                                            `å æ¯”: ${percentage}%`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('ä»ªå™¨å°æ•°åˆ†å¸ƒå›¾åˆ›å»ºæˆåŠŸ');
            } catch (error) {
                console.error('åˆ›å»ºä»ªå™¨å°æ•°åˆ†å¸ƒå›¾å¤±è´¥:', error);
            }
        } else {
            console.log('ä»ªå™¨å°æ•°åˆ†å¸ƒå›¾ï¼šæ— æ•°æ®æˆ–canvasä¸å­˜åœ¨');
        }
        
        console.log('å›¾è¡¨åˆå§‹åŒ–å®Œæˆ');
    });
</script>
   

{% endblock %}

{% block content %}
    {{ block.super }}
{% endblock %} 