<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.13/lib/theme-chalk/index.css" />
    <title>é”€å”®å·¥ä½œæ—¥æŠ¥ - æ–°ç‰ˆ</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style scoped>
        /* é˜²æ­¢Vueæ¨¡æ¿é—ªçƒ */
        [v-cloak] {
            display: none;
        }

        .el-form-item__label {
            font-weight: bold;
        }

        .form-container {
            margin: 20px;
            max-width: 900px;
        }

        .section-title {
            font-size: 16px;
            font-weight: bold;
            color: #409EFF;
            margin: 20px 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #409EFF;
        }

        .project-info-box {
            background-color: #f5f7fa;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }

        .project-info-box .info-item {
            margin: 5px 0;
            color: #606266;
        }

        .project-info-box .info-label {
            font-weight: bold;
            color: #303133;
        }
    </style>
</head>

<body>
    {% csrf_token %}
    <div id="app" v-cloak>
        <div class="form-container">
            <el-form :rules="rules" :model="form" label-width="150px" size="mini" ref="ruleForm"
                label-position="top">

                <!-- åŸºæœ¬ä¿¡æ¯ -->
                <div class="section-title">åŸºæœ¬ä¿¡æ¯</div>
                <el-form-item label="å¡«æŠ¥æ—¥æœŸ:" required>
                    <el-date-picker type="date" placeholder="é€‰æ‹©æ—¥æœŸ" v-model="form.date1" style="width: 100%;" readonly>
                    </el-date-picker>
                </el-form-item>

                <!-- é¡¹ç›®é€‰æ‹© -->
                <div class="section-title">é¡¹ç›®ä¿¡æ¯</div>
                <el-form-item label="é€‰æ‹©é¡¹ç›®:" prop="projectMode">
                    <el-radio-group v-model="form.projectMode" @change="handleProjectModeChange">
                        <el-radio label="existing">é€‰æ‹©ç°æœ‰é¡¹ç›®</el-radio>
                        <el-radio label="new">æ–°å»ºé¡¹ç›®</el-radio>
                    </el-radio-group>
                </el-form-item>

                <!-- é€‰æ‹©ç°æœ‰é¡¹ç›® -->
                <div v-if="form.projectMode === 'existing'">
                    <el-form-item label="é¡¹ç›®:" prop="selectedProject">
                        <el-select v-model="form.selectedProject" placeholder="è¯·é€‰æ‹©é¡¹ç›®" style="width: 100%;"
                            filterable remote :remote-method="searchProjects" :loading="projectsLoading"
                            @change="handleProjectSelect">
                            <el-option v-for="project in projects" :key="project.id"
                                :label="`${project.name} (${project.project_code})`" :value="project.id">
                                <span style="float: left">[[ project.name ]]</span>
                                <span style="float: right; color: #8492a6; font-size: 12px">[[
                                    project.current_stage ]]</span>
                            </el-option>
                        </el-select>
                    </el-form-item>

                    <!-- æ˜¾ç¤ºé€‰ä¸­é¡¹ç›®çš„ä¿¡æ¯ -->
                    <div v-if="selectedProjectInfo" class="project-info-box">
                        <div class="info-item">
                            <span class="info-label">é¡¹ç›®ç¼–å·ï¼š</span>[[ selectedProjectInfo.project_code ]]
                        </div>
                        <div class="info-item">
                            <span class="info-label">å®¢æˆ·åç§°ï¼š</span>[[ selectedProjectInfo.customer_name ]]
                        </div>
                        <div class="info-item">
                            <span class="info-label">å½“å‰é˜¶æ®µï¼š</span>
                            <el-tag size="small" :type="getStageTagType(selectedProjectInfo.current_stage)">
                                [[ selectedProjectInfo.current_stage ]]
                            </el-tag>
                        </div>
                        <div class="info-item">
                            <span class="info-label">é¡¹ç›®çŠ¶æ€ï¼š</span>[[ getStatusText(selectedProjectInfo.status) ]]
                        </div>
                    </div>

                </div>

                <!-- æ–°å»ºé¡¹ç›® -->
                <div v-if="form.projectMode === 'new'">
                    <el-form-item label="å®¢æˆ·åç§°:" prop="customerName">
                        <el-autocomplete v-model="form.customerName" :fetch-suggestions="searchCustomers"
                            placeholder="è¯·è¾“å…¥å®¢æˆ·åç§°" style="width: 100%;" @select="handleCustomerSelect">
                        </el-autocomplete>
                    </el-form-item>

                    <el-form-item label="é¡¹ç›®åç§°:" prop="projectName">
                        <el-input v-model="form.projectName" placeholder="è¯·è¾“å…¥é¡¹ç›®åç§°" style="width: 100%;"></el-input>
                    </el-form-item>

                    <el-form-item label="å½“å‰é˜¶æ®µ:" prop="currentStage">
                        <el-select v-model="form.currentStage" placeholder="è¯·é€‰æ‹©å½“å‰é˜¶æ®µ" style="width: 100%;">
                            <el-option v-for="stage in stageChoices" :key="stage.value" :label="stage.label"
                                :value="stage.value">
                            </el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="é¢„è®¡é‡‘é¢(å…ƒ):">
                        <el-input v-model.number="form.estimatedAmount" placeholder="è¯·è¾“å…¥é¢„è®¡é‡‘é¢" style="width: 100%;">
                        </el-input>
                    </el-form-item>

                    <el-form-item label="é¢„è®¡æˆäº¤æ—¶é—´:">
                        <el-date-picker type="date" v-model="form.expectedCloseDate" placeholder="é€‰æ‹©é¢„è®¡æˆäº¤æ—¶é—´"
                            style="width: 100%;">
                        </el-date-picker>
                    </el-form-item>

                    <el-form-item label="é¡¹ç›®æè¿°:">
                        <el-input type="textarea" v-model="form.projectDesc" placeholder="è¯·ç®€è¿°é¡¹ç›®èƒŒæ™¯å’Œéœ€æ±‚" :rows="3"
                            style="width: 100%;"></el-input>
                    </el-form-item>
                </div>

                <!-- æ“ä½œç±»å‹é€‰æ‹© (æ ¸å¿ƒæ”¹åŠ¨) -->
                <div v-if="form.projectMode === 'existing' && form.selectedProject" class="section-title">ä»Šå¤©è¦åšä»€ä¹ˆï¼Ÿ</div>
                <el-form-item v-if="form.projectMode === 'existing' && form.selectedProject" label="æ“ä½œç±»å‹:" prop="operationType">
                    <el-radio-group v-model="form.operationType" @change="handleOperationTypeChange">
                        <el-radio label="activity">
                            <i class="el-icon-edit"></i> è®°å½•è·Ÿè¿›æ´»åŠ¨ï¼ˆé˜¶æ®µä¸å˜ï¼‰
                        </el-radio>
                        <el-radio label="advance">
                            <i class="el-icon-top"></i> æ¨è¿›é¡¹ç›®é˜¶æ®µ
                        </el-radio>
                        <el-radio label="conclude">
                            <i class="el-icon-check"></i> æ ‡è®°é¡¹ç›®ç»“æœï¼ˆèµ¢å•/è¾“å•/æš‚åœï¼‰
                        </el-radio>
                    </el-radio-group>
                </el-form-item>

                <!-- æ“ä½œ1ï¼šè®°å½•è·Ÿè¿›æ´»åŠ¨ -->
                <div v-if="form.operationType === 'activity'">
                    <div class="section-title">æ´»åŠ¨è®°å½•</div>

                    <el-form-item label="æ´»åŠ¨ç±»å‹:" prop="activityType">
                        <el-select v-model="form.activityType" placeholder="è¯·é€‰æ‹©æ´»åŠ¨ç±»å‹" style="width: 100%;">
                            <el-option label="ğŸ‘¥ å®¢æˆ·æ´»åŠ¨" value="customer"></el-option>
                            <el-option label="ğŸ“ å†…éƒ¨å·¥ä½œ" value="internal"></el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="æ´»åŠ¨å†…å®¹:" prop="activityContent">
                        <el-input type="textarea" v-model="form.activityContent"
                                  placeholder="è¯·æè¿°ä»Šå¤©é’ˆå¯¹è¯¥é¡¹ç›®å¼€å±•çš„å…·ä½“å·¥ä½œ"
                                  :rows="3" style="width: 100%;"></el-input>
                    </el-form-item>

                    <el-form-item label="ä¸‹æ¬¡è®¡åˆ’è·Ÿè¿›æ—¶é—´:">
                        <el-date-picker v-model="form.nextPlanDate" type="date" placeholder="é€‰æ‹©ä¸‹æ¬¡è·Ÿè¿›æ—¶é—´"
                                        style="width: 100%;"></el-date-picker>
                    </el-form-item>
                </div>

                <!-- æ“ä½œ2ï¼šæ¨è¿›é¡¹ç›®é˜¶æ®µ -->
                <div v-if="form.operationType === 'advance'">
                    <div class="section-title">é˜¶æ®µæ¨è¿›</div>

                    <el-alert type="info" :closable="false" style="margin-bottom: 15px;" v-if="selectedProjectInfo">
                        å½“å‰é˜¶æ®µ: <strong>[[ selectedProjectInfo.current_stage ]]</strong>
                    </el-alert>

                    <el-form-item label="æ¨è¿›åˆ°:" prop="newStage">
                        <el-select v-model="form.newStage" placeholder="è¯·é€‰æ‹©æ–°é˜¶æ®µ" style="width: 100%;">
                            <el-option v-for="stage in stageChoices"
                                       :key="stage.value"
                                       :label="stage.label"
                                       :value="stage.value">
                            </el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="æ¨è¿›å…³é”®äº‹ä»¶:" prop="stageAdvanceReason">
                        <el-input type="textarea" v-model="form.stageAdvanceReason"
                                  placeholder="è¯·è¯´æ˜é¡¹ç›®æ¨è¿›çš„å…³é”®äº‹ä»¶æˆ–åŸå› ï¼ˆå¦‚ï¼šå®¢æˆ·ç¡®è®¤æ–¹æ¡ˆã€å®ŒæˆæŠ€æœ¯æ¼”ç¤ºã€æ”¶åˆ°ä¸­æ ‡é€šçŸ¥ç­‰ï¼‰"
                                  :rows="3" style="width: 100%;"></el-input>
                    </el-form-item>

                    <el-form-item label="é¢„è®¡æˆäº¤æ—¶é—´ï¼ˆå¯é€‰æ›´æ–°ï¼‰:">
                        <el-date-picker v-model="form.expectedCloseDate" type="date" placeholder="é€‰æ‹©é¢„è®¡æˆäº¤æ—¶é—´"
                                        style="width: 100%;"></el-date-picker>
                    </el-form-item>
                </div>

                <!-- æ“ä½œ3ï¼šæ ‡è®°é¡¹ç›®ç»“æœ -->
                <div v-if="form.operationType === 'conclude'">
                    <div class="section-title">é¡¹ç›®ç»“æœ</div>

                    <el-form-item label="ç»“æœç±»å‹:" prop="conclusionType">
                        <el-radio-group v-model="form.conclusionType" @change="handleConclusionTypeChange">
                            <el-radio label="won">âœ… èµ¢å•</el-radio>
                            <el-radio label="lost">âŒ è¾“å•</el-radio>
                            <el-radio label="suspended">â¸ï¸ æš‚åœè·Ÿè¿›</el-radio>
                        </el-radio-group>
                    </el-form-item>

                    <!-- èµ¢å•è¡¨å• -->
                    <div v-if="form.conclusionType === 'won'">
                        <el-form-item label="å®é™…æˆäº¤é‡‘é¢(å…ƒ):" prop="actualAmount">
                            <el-input v-model.number="form.actualAmount" placeholder="è¯·è¾“å…¥å®é™…æˆäº¤é‡‘é¢" style="width: 100%;"></el-input>
                        </el-form-item>
                        <el-form-item label="æˆäº¤æ—¶é—´:">
                            <el-date-picker v-model="form.actualCloseDate" type="date" placeholder="é€‰æ‹©æˆäº¤æ—¶é—´"
                                            style="width: 100%;"></el-date-picker>
                        </el-form-item>
                        <el-form-item label="å¤‡æ³¨:">
                            <el-input type="textarea" v-model="form.winRemark" :rows="2" style="width: 100%;"></el-input>
                        </el-form-item>
                    </div>

                    <!-- è¾“å•è¡¨å• -->
                    <div v-if="form.conclusionType === 'lost'">
                        <el-form-item label="æµå¤±åŸå› :" prop="lostReason">
                            <el-select v-model="form.lostReason" placeholder="è¯·é€‰æ‹©æµå¤±åŸå› " style="width: 100%;">
                                <el-option label="ä»·æ ¼å› ç´ " value="price"></el-option>
                                <el-option label="ç«äº‰å¯¹æ‰‹ä¸­æ ‡" value="competitor"></el-option>
                                <el-option label="å®¢æˆ·é¢„ç®—å–æ¶ˆ" value="budget_cancel"></el-option>
                                <el-option label="äº§å“ä¸ç¬¦åˆéœ€æ±‚" value="product_mismatch"></el-option>
                                <el-option label="æ—¶æœºä¸åˆé€‚" value="timing"></el-option>
                                <el-option label="å…¶ä»–" value="other"></el-option>
                            </el-select>
                        </el-form-item>
                        <el-form-item label="ä¸»è¦ç«äº‰å¯¹æ‰‹ï¼ˆå¦‚é€‚ç”¨ï¼‰:">
                            <el-input v-model="form.competitorInfo" placeholder="å¦‚å› ç«äº‰å¯¹æ‰‹å¤±è´¥ï¼Œè¯·å¡«å†™" style="width: 100%;"></el-input>
                        </el-form-item>
                        <el-form-item label="è¯¦ç»†è¯´æ˜:" prop="lostDetail">
                            <el-input type="textarea" v-model="form.lostDetail"
                                      placeholder="è¯·è¯¦ç»†è¯´æ˜é¡¹ç›®æµå¤±çš„åŸå› å’Œç»è¿‡"
                                      :rows="3" style="width: 100%;"></el-input>
                        </el-form-item>
                    </div>

                    <!-- æš‚åœè¡¨å• -->
                    <div v-if="form.conclusionType === 'suspended'">
                        <el-form-item label="æš‚åœåŸå› :" prop="suspendReason">
                            <el-input type="textarea" v-model="form.suspendReason"
                                      placeholder="è¯·è¯´æ˜æš‚åœè·Ÿè¿›çš„åŸå› "
                                      :rows="2" style="width: 100%;"></el-input>
                        </el-form-item>
                        <el-form-item label="é¢„è®¡æ¢å¤æ—¶é—´:">
                            <el-date-picker v-model="form.expectedResumeDate" type="date" placeholder="é€‰æ‹©é¢„è®¡æ¢å¤æ—¶é—´"
                                            style="width: 100%;"></el-date-picker>
                        </el-form-item>
                    </div>
                </div>

                <!-- æ“ä½œæŒ‰é’® -->
                <el-form-item>
                    <el-button type="primary" @click="submitForm('ruleForm')">æäº¤</el-button>
                    <el-button @click="resetForm('ruleForm')">é‡ç½®</el-button>
                </el-form-item>
            </el-form>
        </div>
    </div>

    <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.13/lib/index.js"></script>
    <script>
        // è·å–CSRF tokençš„è¾…åŠ©å‡½æ•°
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        const csrftoken = getCookie('csrftoken');

        // é…ç½®axiosé»˜è®¤åŒ…å«CSRF token
        axios.defaults.headers.common['X-CSRFToken'] = csrftoken;

        new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data() {
                return {
                    form: {
                        // åŸºæœ¬ä¿¡æ¯
                        date1: '',
                        projectMode: 'existing',  // existing æˆ– new
                        selectedProject: '',

                        // æ ¸å¿ƒï¼šæ“ä½œç±»å‹
                        operationType: 'activity',  // activity/advance/conclude

                        // æ´»åŠ¨è®°å½•ç›¸å…³
                        activityType: '',
                        activityContent: '',
                        nextPlanDate: '',

                        // é˜¶æ®µæ¨è¿›ç›¸å…³
                        newStage: '',
                        stageAdvanceReason: '',
                        expectedCloseDate: '',

                        // é¡¹ç›®ç»“æœç›¸å…³
                        conclusionType: '',  // won/lost/suspended
                        actualAmount: null,
                        actualCloseDate: '',
                        winRemark: '',
                        lostReason: '',
                        competitorInfo: '',
                        lostDetail: '',
                        suspendReason: '',
                        expectedResumeDate: null,

                        // æ–°å»ºé¡¹ç›®ç›¸å…³ï¼ˆä¿æŒä¸å˜ï¼‰
                        customerName: '',
                        projectName: '',
                        currentStage: 'çº¿ç´¢è·å–',
                        estimatedAmount: '',
                        projectDesc: '',
                    },
                    rules: {
                        selectedProject: [
                            { required: true, message: 'è¯·é€‰æ‹©é¡¹ç›®', trigger: 'change' }
                        ],
                        operationType: [
                            { required: true, message: 'è¯·é€‰æ‹©æ“ä½œç±»å‹', trigger: 'change' }
                        ],
                        // æ–°å»ºé¡¹ç›®éªŒè¯
                        customerName: [
                            { required: true, message: 'è¯·è¾“å…¥å®¢æˆ·åç§°', trigger: 'blur' }
                        ],
                        projectName: [
                            { required: true, message: 'è¯·è¾“å…¥é¡¹ç›®åç§°', trigger: 'blur' }
                        ],
                        currentStage: [
                            { required: true, message: 'è¯·é€‰æ‹©å½“å‰é˜¶æ®µ', trigger: 'change' }
                        ],
                        // æ´»åŠ¨è®°å½•éªŒè¯
                        activityType: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'activity' && !value) {
                                        callback(new Error('è¯·é€‰æ‹©æ´»åŠ¨ç±»å‹'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'change'
                            }
                        ],
                        activityContent: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'activity' && !value) {
                                        callback(new Error('è¯·å¡«å†™æ´»åŠ¨å†…å®¹'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'blur'
                            }
                        ],
                        // é˜¶æ®µæ¨è¿›éªŒè¯
                        newStage: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'advance' && !value) {
                                        callback(new Error('è¯·é€‰æ‹©æ–°é˜¶æ®µ'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'change'
                            }
                        ],
                        stageAdvanceReason: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'advance' && !value) {
                                        callback(new Error('è¯·å¡«å†™æ¨è¿›å…³é”®äº‹ä»¶'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'blur'
                            }
                        ],
                        // é¡¹ç›®ç»“æœéªŒè¯
                        conclusionType: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'conclude' && !value) {
                                        callback(new Error('è¯·é€‰æ‹©ç»“æœç±»å‹'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'change'
                            }
                        ],
                        actualAmount: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'conclude' &&
                                        this.form.conclusionType === 'won' && !value) {
                                        callback(new Error('è¯·è¾“å…¥å®é™…æˆäº¤é‡‘é¢'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'blur'
                            }
                        ],
                        lostReason: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'conclude' &&
                                        this.form.conclusionType === 'lost' && !value) {
                                        callback(new Error('è¯·é€‰æ‹©æµå¤±åŸå› '));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'change'
                            }
                        ],
                        lostDetail: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'conclude' &&
                                        this.form.conclusionType === 'lost' && !value) {
                                        callback(new Error('è¯·å¡«å†™è¯¦ç»†è¯´æ˜'));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'blur'
                            }
                        ],
                        suspendReason: [
                            {
                                validator: (rule, value, callback) => {
                                    if (this.form.operationType === 'conclude' &&
                                        this.form.conclusionType === 'suspended' && !value) {
                                        callback(new Error('è¯·å¡«å†™æš‚åœåŸå› '));
                                    } else {
                                        callback();
                                    }
                                },
                                trigger: 'blur'
                            }
                        ],
                    },
                    projects: [],
                    projectsLoading: false,
                    selectedProjectInfo: null,
                    stageChoices: [
                        { value: 'çº¿ç´¢è·å–', label: 'çº¿ç´¢è·å–' },
                        { value: 'çº¿ç´¢éªŒè¯/å»ºæ¡£', label: 'çº¿ç´¢éªŒè¯/å»ºæ¡£' },
                        { value: 'å•†æœºç«‹é¡¹', label: 'å•†æœºç«‹é¡¹' },
                        { value: 'éœ€æ±‚è°ƒç ”', label: 'éœ€æ±‚è°ƒç ”' },
                        { value: 'æ–¹æ¡ˆ/æŠ¥ä»·', label: 'æ–¹æ¡ˆ/æŠ¥ä»·' },
                        { value: 'æµ‹è¯•/éªŒè¯', label: 'æµ‹è¯•/éªŒè¯' },
                        { value: 'å‡†å…¥/å…³é”®äººè®¤å¯', label: 'å‡†å…¥/å…³é”®äººè®¤å¯' },
                        { value: 'å•†åŠ¡è°ˆåˆ¤', label: 'å•†åŠ¡è°ˆåˆ¤' },
                        { value: 'æ‹›é‡‡/æŒ‚ç½‘/æ¯”é€‰', label: 'æ‹›é‡‡/æŒ‚ç½‘/æ¯”é€‰' },
                        { value: 'ä¸­æ ‡/èµ¢å•', label: 'ä¸­æ ‡/èµ¢å•' },
                        { value: 'è£…æœº/éªŒæ”¶', label: 'è£…æœº/éªŒæ”¶' },
                        { value: 'æ”¶å•', label: 'æ”¶å•' },
                    ]
                }
            },
            methods: {
                async searchProjects(query) {
                    if (query !== '') {
                        this.projectsLoading = true;
                        try {
                            const response = await axios.get('/SALESREPORT/api/projects/', {
                                params: { search: query }
                            });
                            this.projects = response.data;
                        } catch (error) {
                            this.$message.error('æœç´¢é¡¹ç›®å¤±è´¥');
                            console.error(error);
                        } finally {
                            this.projectsLoading = false;
                        }
                    } else {
                        this.projects = [];
                    }
                },
                async handleProjectSelect(projectId) {
                    try {
                        const response = await axios.get(`/SALESREPORT/api/projects/${projectId}/`);
                        this.selectedProjectInfo = response.data;
                    } catch (error) {
                        this.$message.error('è·å–é¡¹ç›®ä¿¡æ¯å¤±è´¥');
                        console.error(error);
                    }
                },
                async searchCustomers(queryString, cb) {
                    if (queryString) {
                        try {
                            const response = await axios.get('/SALESREPORT/api/customers/', {
                                params: { search: queryString }
                            });
                            const results = response.data.map(c => ({ value: c.name, id: c.id }));
                            cb(results);
                        } catch (error) {
                            cb([]);
                        }
                    } else {
                        cb([]);
                    }
                },
                handleCustomerSelect(item) {
                    this.form.customerName = item.value;
                },
                handleProjectModeChange(mode) {
                    // åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½®ç›¸å…³å­—æ®µ
                    this.selectedProjectInfo = null;
                    this.form.operationType = 'activity';
                },
                handleOperationTypeChange(value) {
                    // åˆ‡æ¢æ“ä½œç±»å‹æ—¶ï¼Œæ¸…ç©ºç›¸å…³å­—æ®µ
                    if (value === 'activity') {
                        this.form.newStage = '';
                        this.form.stageAdvanceReason = '';
                        this.form.conclusionType = '';
                    } else if (value === 'advance') {
                        this.form.activityType = '';
                        this.form.activityContent = '';
                        this.form.conclusionType = '';
                    } else if (value === 'conclude') {
                        this.form.activityType = '';
                        this.form.activityContent = '';
                        this.form.newStage = '';
                        this.form.stageAdvanceReason = '';
                    }
                },
                handleConclusionTypeChange(value) {
                    // åˆ‡æ¢ç»“æœç±»å‹æ—¶ï¼Œæ¸…ç©ºå…¶ä»–ç»“æœç›¸å…³å­—æ®µ
                    if (value === 'won') {
                        this.form.lostReason = '';
                        this.form.competitorInfo = '';
                        this.form.lostDetail = '';
                        this.form.suspendReason = '';
                        this.form.expectedResumeDate = null;
                        this.form.actualCloseDate = new Date();
                    } else if (value === 'lost') {
                        this.form.actualAmount = null;
                        this.form.actualCloseDate = '';
                        this.form.winRemark = '';
                        this.form.suspendReason = '';
                        this.form.expectedResumeDate = null;
                    } else if (value === 'suspended') {
                        this.form.actualAmount = null;
                        this.form.actualCloseDate = '';
                        this.form.winRemark = '';
                        this.form.lostReason = '';
                        this.form.competitorInfo = '';
                        this.form.lostDetail = '';
                    }
                },
                getStageTagType(stage) {
                    const stageIndex = this.stageChoices.findIndex(s => s.value === stage);
                    if (stageIndex < 3) return 'info';
                    if (stageIndex < 6) return 'warning';
                    if (stageIndex < 9) return '';
                    return 'success';
                },
                getStatusText(status) {
                    const statusMap = {
                        'active': 'è¿›è¡Œä¸­',
                        'won': 'å·²èµ¢å•',
                        'lost': 'å·²æµå¤±',
                        'suspended': 'æš‚åœè·Ÿè¿›'
                    };
                    return statusMap[status] || status;
                },
                async submitForm(formName) {
                    this.$refs[formName].validate(async (valid) => {
                        if (valid) {
                            try {
                                await this.$confirm('æ‚¨ç¡®å®šè¦æäº¤å—ï¼Ÿ', 'æç¤º', {
                                    confirmButtonText: 'ç¡®å®š',
                                    cancelButtonText: 'å–æ¶ˆ',
                                    type: 'warning'
                                });

                                // æ„å»ºæäº¤æ•°æ®
                                let submitData = {
                                    date1: this.form.date1 ? this.form.date1.toISOString() : new Date().toISOString(),
                                    projectMode: this.form.projectMode,
                                };

                                if (this.form.projectMode === 'new') {
                                    // æ–°å»ºé¡¹ç›®é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼‰
                                    submitData.customerName = this.form.customerName;
                                    submitData.projectName = this.form.projectName;
                                    submitData.currentStage = this.form.currentStage;
                                    submitData.estimatedAmount = this.form.estimatedAmount;
                                    submitData.expectedCloseDate = this.form.expectedCloseDate ? this.form.expectedCloseDate.toISOString() : null;
                                    submitData.projectDesc = this.form.projectDesc;
                                } else {
                                    // é€‰æ‹©ç°æœ‰é¡¹ç›®
                                    submitData.selectedProject = this.form.selectedProject;
                                    submitData.operationType = this.form.operationType;

                                    // æ ¹æ®æ“ä½œç±»å‹æ·»åŠ å¯¹åº”æ•°æ®
                                    if (this.form.operationType === 'activity') {
                                        submitData.activityType = this.form.activityType;
                                        submitData.activityContent = this.form.activityContent;
                                        submitData.nextPlanDate = this.form.nextPlanDate ? this.form.nextPlanDate.toISOString() : null;

                                    } else if (this.form.operationType === 'advance') {
                                        submitData.newStage = this.form.newStage;
                                        submitData.stageAdvanceReason = this.form.stageAdvanceReason;
                                        submitData.expectedCloseDate = this.form.expectedCloseDate ? this.form.expectedCloseDate.toISOString() : null;

                                    } else if (this.form.operationType === 'conclude') {
                                        submitData.conclusionType = this.form.conclusionType;

                                        if (this.form.conclusionType === 'won') {
                                            submitData.actualAmount = this.form.actualAmount;
                                            submitData.actualCloseDate = this.form.actualCloseDate ? this.form.actualCloseDate.toISOString() : null;
                                            submitData.winRemark = this.form.winRemark;
                                        } else if (this.form.conclusionType === 'lost') {
                                            submitData.lostReason = this.form.lostReason;
                                            submitData.competitorInfo = this.form.competitorInfo;
                                            submitData.lostDetail = this.form.lostDetail;
                                        } else if (this.form.conclusionType === 'suspended') {
                                            submitData.suspendReason = this.form.suspendReason;
                                            submitData.expectedResumeDate = this.form.expectedResumeDate ? this.form.expectedResumeDate.toISOString() : null;
                                        }
                                    }
                                }

                                const response = await axios.post('/SALESREPORT/reportsubmit', submitData);
                                this.$message({
                                    type: 'success',
                                    message: response.data.message || 'æäº¤æˆåŠŸï¼'
                                });
                                this.resetForm(formName);
                            } catch (error) {
                                if (error === 'cancel') {
                                    this.$message({
                                        type: 'info',
                                        message: 'å·²å–æ¶ˆæäº¤'
                                    });
                                } else {
                                    this.$message({
                                        type: 'error',
                                        message: error.response?.data?.message || 'æäº¤å¤±è´¥'
                                    });
                                }
                            }
                        } else {
                            this.$message.error('è¯·å®Œå–„å¿…å¡«ä¿¡æ¯');
                            return false;
                        }
                    });
                },
                resetForm(formName) {
                    this.$refs[formName].resetFields();
                    this.selectedProjectInfo = null;
                    this.projects = [];
                }
            },
            mounted() {
                try {
                    const contextDate = new Date('{{today|safe}}');
                    this.form.date1 = contextDate;
                } catch (e) {
                    console.error("è§£ææ—¥æœŸå‡ºé”™:", e);
                }

                // åŠ è½½å½“å‰ç”¨æˆ·çš„æ´»è·ƒé¡¹ç›®
                this.searchProjects('');
            },
        });
    </script>
</body>

</html>
