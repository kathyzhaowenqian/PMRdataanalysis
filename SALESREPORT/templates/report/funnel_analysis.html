<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”€å”®æ¼æ–—åˆ†æ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui@2.15.13/lib/theme-chalk/index.css" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui@2.15.13/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background-color: #f5f7fa;
            font-family: "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", Arial, sans-serif;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .summary-card .label {
            font-size: 14px;
            color: #909399;
            margin-bottom: 10px;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #303133;
        }

        .summary-card .value.primary {
            color: #1E3A8A;
        }

        .summary-card .value.success {
            color: #06B6D4;
        }

        .summary-card .value.warning {
            color: #7DAEA3;
        }

        .chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .chart-title {
            font-size: 18px;
            font-weight: bold;
            color: #303133;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #1E3A8A;
        }

        .chart {
            width: 100%;
            height: 600px;
        }

        .funnel-charts-row {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .funnel-chart-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .funnel-chart {
            width: 100%;
            height: 800px;
        }

        .filters {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body>
    <div id="app" class="container">
        <div class="page-title">ğŸ“Š é”€å”®æ¼æ–—åˆ†æ</div>

        <!-- ç­›é€‰æ¡ä»¶ -->
        <div class="filters">
            <el-row :gutter="20">
                <el-col :span="6">
                    <el-select v-model="filters.days" placeholder="æ—¶é—´èŒƒå›´" @change="loadData">
                        <el-option label="æœ€è¿‘30å¤©" :value="30"></el-option>
                        <el-option label="æœ€è¿‘90å¤©" :value="90"></el-option>
                        <el-option label="æœ€è¿‘180å¤©" :value="180"></el-option>
                        <el-option label="æœ€è¿‘1å¹´" :value="365"></el-option>
                        <el-option label="å…¨éƒ¨" :value="99999"></el-option>
                    </el-select>
                </el-col>
                <el-col :span="6">
                    <el-button type="primary" @click="loadData">åˆ·æ–°æ•°æ®</el-button>
                </el-col>
            </el-row>
        </div>

        <!-- æ±‡æ€»å¡ç‰‡ -->
        {% verbatim %}
        <div class="summary-cards" v-if="summary">
            <div class="summary-card">
                <div class="label">æ€»é¡¹ç›®æ•°</div>
                <div class="value primary">{{ summary.total_projects }}</div>
            </div>
            <div class="summary-card">
                <div class="label">è¿›è¡Œä¸­é¡¹ç›®</div>
                <div class="value">{{ summary.active_projects }}</div>
            </div>
            <div class="summary-card">
                <div class="label">å·²èµ¢å•é¡¹ç›®</div>
                <div class="value success">{{ summary.won_projects }}</div>
            </div>
            <div class="summary-card">
                <div class="label">èµ¢å•ç‡</div>
                <div class="value warning">{{ summary.won_rate }}%</div>
            </div>
            <div class="summary-card">
                <div class="label">èµ¢å•æ€»é‡‘é¢</div>
                <div class="value success">Â¥{{ formatAmount(summary.total_won_amount) }}</div>
            </div>
        </div>
        {% endverbatim %}

        <!-- æ¼æ–—å›¾å¹¶æ’æ˜¾ç¤º -->
        <div class="funnel-charts-row">
            <!-- ä¸¥æ ¼æ¼æ–—å›¾ -->
            <div class="funnel-chart-container">
                <div class="chart-title">
                    é”€å”®é˜¶æ®µæ¼æ–— - ä¸¥æ ¼æ¨¡å¼
                    <span style="font-size: 12px; color: #909399; font-weight: normal; margin-left: 15px;">
                        åªç»Ÿè®¡å®é™…å¡«æŠ¥è¿‡è¯¥é˜¶æ®µçš„é¡¹ç›®æ•°
                    </span>
                </div>
                <div id="funnelChartStrict" class="funnel-chart"></div>
            </div>

            <!-- è¡¥é½æ¼æ–—å›¾ï¼ˆå¸¦è·³å¡«ç‡æ ‡æ³¨ï¼‰ -->
            <div class="funnel-chart-container">
                <div class="chart-title">
                    é”€å”®é˜¶æ®µæ¼æ–— - è¡¥é½æ¨¡å¼
                    <span style="font-size: 12px; color: #909399; font-weight: normal; margin-left: 15px;">
                        åˆ°è¾¾åç»­é˜¶æ®µç®—å®Œæˆå‰é¢é˜¶æ®µ | è·³å¡«ç‡æ˜¾ç¤ºåœ¨æ ‡ç­¾å’Œé¢œè‰²ä¸­
                    </span>
                </div>
                <div id="funnelChartFilled" class="funnel-chart"></div>
            </div>
        </div>

        <!-- é”€å”®äººå‘˜ä¸šç»©åˆ†æ -->
        <div class="chart-container">
            <div class="chart-title">
                é”€å”®äººå‘˜ä¸šç»©æ’è¡Œæ¦œ
                <span style="font-size: 12px; color: #909399; font-weight: normal; margin-left: 15px;">
                    æŒ‰èµ¢å•é‡‘é¢æ’åº | æ˜¾ç¤ºèµ¢å•ç‡ã€åœ¨é€”é¡¹ç›®é‡‘é¢
                </span>
            </div>
            <div id="performanceChart" class="chart"></div>
        </div>

        <!-- é˜¶æ®µè·³å¡«åˆ†æ -->
        <div class="chart-container">
            <div class="chart-title">
                é˜¶æ®µè·³å¡«/æ¼å¡«åˆ†æ
                <span style="font-size: 12px; color: #909399; font-weight: normal; margin-left: 15px;">
                    æ˜¾ç¤ºåˆ°è¾¾åç»­é˜¶æ®µä½†æœªå¡«æŠ¥è¯¥é˜¶æ®µçš„é¡¹ç›®æ¯”ä¾‹
                </span>
            </div>
            <div id="skipFillChart" class="chart"></div>
        </div>

        <!-- åœç•™æ—¶é—´åˆ†æ -->
        <div class="chart-container">
            <div class="chart-title">
                å„é˜¶æ®µåœç•™æ—¶é—´åˆ†æï¼ˆå¤©ï¼‰
                <span style="font-size: 12px; color: #909399; font-weight: normal; margin-left: 15px;">
                    ä»…ç»Ÿè®¡å®é™…å¡«æŠ¥è¿‡è¯¥é˜¶æ®µçš„é¡¹ç›® | æŸ±çŠ¶å›¾=ä¸­ä½æ•°ï¼ŒæŠ˜çº¿=å¹³å‡å€¼
                </span>
            </div>
            <div id="durationChart" class="chart"></div>
        </div>

        <!-- æœˆåº¦è¶‹åŠ¿ -->
        <div class="chart-container">
            <div class="chart-title">æœˆåº¦æ–°å¢é¡¹ç›®è¶‹åŠ¿</div>
            <div id="trendChart" class="chart"></div>
        </div>
    </div>

    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    filters: {
                        days: 90,
                        salesman: null,
                        company: null,
                    },
                    summary: null,

                    // æ–°å¢å­—æ®µ
                    stageStatsStrict: null,  // ä¸¥æ ¼æ¼æ–—æ•°æ®
                    stageStatsFilled: null,  // è¡¥é½æ¼æ–—æ•°æ®

                    // ä¿ç•™å…¼å®¹å­—æ®µ
                    stageStats: null,
                    stageStatsOrdered: null,

                    // å…¶ä»–å­—æ®µ
                    conversionRates: null,
                    stageDuration: null,
                    stageDurationAnalysis: null,  // åœç•™æ—¶é—´åˆ†æï¼ˆåŒ…å«ä¸­ä½æ•°ã€æ ·æœ¬é‡ï¼‰
                    skipFillStats: null,  // è·³å¡«åˆ†ææ•°æ®
                    monthlyTrend: null,
                    performanceData: null,  // é”€å”®äººå‘˜ä¸šç»©æ•°æ®
                    loading: false,
                }
            },
            mounted() {
                this.loadData();
            },
            methods: {
                async loadData() {
                    this.loading = true;
                    try {
                        const params = {
                            days: this.filters.days,
                        };

                        // å¹¶è¡Œè¯·æ±‚ä¸¤ä¸ªAPI
                        const [funnelResponse, performanceResponse] = await Promise.all([
                            axios.get('/SALESREPORT/api/funnel-data/', { params }),
                            axios.get('/SALESREPORT/api/salesman-performance/', { params })
                        ]);

                        const data = funnelResponse.data;
                        const performanceData = performanceResponse.data;

                        this.summary = data.summary;

                        // æ–°å¢å­—æ®µèµ‹å€¼
                        this.stageStatsStrict = data.stage_stats_strict;
                        this.stageStatsFilled = data.stage_stats_filled;

                        // ä¿ç•™å…¼å®¹å­—æ®µèµ‹å€¼
                        this.stageStats = data.stage_stats;
                        this.stageStatsOrdered = data.stage_stats_ordered;

                        this.conversionRates = data.conversion_rates;
                        this.stageDuration = data.stage_duration;
                        this.stageDurationAnalysis = data.stage_duration_analysis;  // æ–°å¢å­—æ®µ
                        this.skipFillStats = data.skip_fill_stats;
                        this.monthlyTrend = data.monthly_trend;
                        this.performanceData = performanceData.performance_data;  // é”€å”®äººå‘˜ä¸šç»©æ•°æ®

                        this.$nextTick(() => {
                            // æ–°å¢ï¼šæ¸²æŸ“ä¸¤ä¸ªæ¼æ–—å›¾
                            this.renderFunnelChartStrict();
                            this.renderFunnelChartFilled();

                            // ç°æœ‰å›¾è¡¨
                            this.renderPerformanceChart();  // æ–°å¢ï¼šé”€å”®äººå‘˜ä¸šç»©å›¾è¡¨
                            this.renderSkipFillChart();
                            this.renderDurationChart();
                            this.renderTrendChart();
                        });
                    } catch (error) {
                        this.$message.error('åŠ è½½æ•°æ®å¤±è´¥');
                        console.error(error);
                    } finally {
                        this.loading = false;
                    }
                },

                renderFunnelChartStrict() {
                    const chart = echarts.init(document.getElementById('funnelChartStrict'));
                    const data = this.stageStatsStrict;

                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: (params) => {
                                const stageIndex = params.dataIndex;
                                const conversionData = this.conversionRates[stageIndex];

                                let html = `<div style="padding: 5px;">`;
                                html += `<strong style="font-size: 14px;">${params.name}</strong><br/><br/>`;
                                html += `å®é™…å¡«æŠ¥è¿‡è¯¥é˜¶æ®µ: <strong>${params.value}</strong> ä¸ªé¡¹ç›®<br/>`;
                                html += `<span style="font-size: 11px; color: #909399;">ï¼ˆä¸¥æ ¼ç»Ÿè®¡ï¼šå¿…é¡»å®é™…å¡«æŠ¥æ‰è®¡å…¥ï¼‰</span>`;

                                // æ˜¾ç¤ºåˆ°ä¸‹ä¸€é˜¶æ®µçš„è½¬åŒ–ç‡
                                if (conversionData && stageIndex < this.stageStatsStrict.length - 1) {
                                    // è®¡ç®—æ•´ä½“æ¨è¿›ç‡ï¼ˆåˆ†æ¯ = æ¼æ–—æ˜¾ç¤ºæ•°ï¼‰
                                    const overall_rate = conversionData.entered_count > 0
                                        ? Math.round(conversionData.direct_count / conversionData.entered_count * 1000) / 10
                                        : 0;

                                    html += `<hr style="border: none; border-top: 1px dashed #ddd; margin: 8px 0;"/>`;

                                    // æ•´ä½“æ¨è¿›ç‡ï¼ˆæ‰€æœ‰è¿›å…¥è¯¥é˜¶æ®µçš„é¡¹ç›®ä¸­å·²æ¨è¿›çš„æ¯”ä¾‹ï¼‰
                                    html += `<div style="margin: 8px 0; padding: 6px; background: #EBF5FF; border-left: 3px solid #1E3A8A;">`;
                                    html += `<span style="color: #1E3A8A;">ğŸ“Š æ•´ä½“æ¨è¿›ç‡</span><br/>`;
                                    html += `<strong style="color: #1E3A8A; font-size: 16px;">${overall_rate}%</strong> `;
                                    html += `(${conversionData.direct_count} Ã· ${conversionData.entered_count})<br/>`;
                                    html += `<span style="font-size: 11px; color: #909399;">å·²æ¨è¿›${conversionData.direct_count}ä¸ªï¼Œè¿˜æœ‰${conversionData.in_progress_count}ä¸ªåœ¨é€”</span>`;
                                    html += `</div>`;
                                }

                                html += `</div>`;
                                return html;
                            }
                        },
                        series: [{
                            type: 'funnel',
                            left: '10%',
                            top: 80,
                            bottom: 80,
                            width: '80%',
                            sort: 'none',
                            gap: 2,
                            label: {
                                show: true,
                                position: 'inside',
                                formatter: (params) => {
                                    const stageIndex = params.dataIndex;
                                    const conversionData = this.conversionRates[stageIndex];

                                    // æœ€åä¸€ä¸ªé˜¶æ®µæ²¡æœ‰ä¸‹ä¸€é˜¶æ®µï¼Œä¸æ˜¾ç¤ºè½¬åŒ–ç‡
                                    if (!conversionData || stageIndex >= this.stageStatsStrict.length - 1) {
                                        return `${params.name}: ${params.value}`;
                                    }

                                    // è®¡ç®—æ•´ä½“æ¨è¿›ç‡ï¼ˆä¸æ¼æ–—æ•°å­—ä¸€è‡´çš„åˆ†æ¯ï¼‰
                                    const overall_rate = conversionData.entered_count > 0
                                        ? Math.round(conversionData.direct_count / conversionData.entered_count * 1000) / 10
                                        : 0;

                                    // æ˜¾ç¤ºæ•´ä½“æ¨è¿›ç‡ï¼ˆæ›´ç›´è§‚ï¼‰
                                    return `${params.name}: ${params.value}\nâ†“ ${overall_rate}%`;
                                },
                                fontSize: 12,
                                lineHeight: 18,
                                color: '#fff',
                                fontWeight: '300'
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 1,
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                    {offset: 0, color: '#3B5BA5'},
                                    {offset: 1, color: '#1E3A8A'}
                                ])
                            },
                            data: data
                        }]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                renderFunnelChartFilled() {
                    const chart = echarts.init(document.getElementById('funnelChartFilled'));
                    const data = this.stageStatsFilled;

                    const option = {
                        tooltip: {
                            trigger: 'item',
                            formatter: (params) => {
                                const stageIndex = params.dataIndex;
                                const conversionData = this.conversionRates[stageIndex];

                                let html = `<div style="padding: 5px;">`;
                                html += `<strong style="font-size: 14px;">${params.name}</strong><br/><br/>`;

                                if (!conversionData) {
                                    html += `åˆ°è¾¾è¯¥é˜¶æ®µæˆ–åç»­: <strong>${params.value}</strong> ä¸ªé¡¹ç›®`;
                                    html += `</div>`;
                                    return html;
                                }

                                html += `åˆ°è¾¾è¯¥é˜¶æ®µæˆ–åç»­: <strong>${params.value}</strong> ä¸ªé¡¹ç›®<br/>`;
                                html += `å®é™…å¡«æŠ¥è¯¥é˜¶æ®µ: <strong>${params.value - conversionData.never_filled_count}</strong> ä¸ª<br/>`;
                                html += `è·³è¿‡æœªå¡«: <strong style="color: #F56C6C;">${conversionData.never_filled_count}</strong> ä¸ª<br/>`;
                                html += `<span style="font-size: 11px; color: #909399;">ï¼ˆè¡¥é½ç»Ÿè®¡ï¼šåˆ°è¾¾åç»­é˜¶æ®µç®—å®Œæˆè¯¥é˜¶æ®µï¼‰</span>`;

                                // æ˜¾ç¤ºè¡¥é½æ¨¡å¼è½¬åŒ–ç‡å’Œè·³å¡«ç‡
                                if (stageIndex < this.stageStatsFilled.length - 1) {
                                    // è®¡ç®—è¡¥é½æ¨¡å¼çš„è½¬åŒ–ç‡
                                    const currentStageValue = this.stageStatsFilled[stageIndex].value;
                                    const nextStageValue = this.stageStatsFilled[stageIndex + 1].value;
                                    const nextStageName = this.stageStatsFilled[stageIndex + 1].name;
                                    const filledConversionRate = currentStageValue > 0
                                        ? Math.round(nextStageValue / currentStageValue * 1000) / 10
                                        : 0;

                                    html += `<hr style="border: none; border-top: 1px dashed #ddd; margin: 8px 0;"/>`;
                                    html += `<div style="margin: 8px 0; padding: 6px; background: #ECFEFF; border-left: 3px solid #06B6D4;">`;
                                    html += `åˆ° ${nextStageName} è½¬åŒ–ç‡: <strong style="color: #06B6D4; font-size: 16px;">${filledConversionRate}%</strong><br/>`;
                                    html += `<span style="font-size: 11px; color: #909399;">ï¼ˆ${nextStageValue} Ã· ${currentStageValue} = ${filledConversionRate}%ï¼‰</span>`;
                                    html += `</div>`;

                                    if (conversionData.skip_fill_rate > 0) {
                                        html += `<div style="margin: 8px 0; padding: 6px; background: #EEE8E5; border-left: 3px solid #C8B5B0;">`;
                                        html += `è·³å¡«ç‡: <strong style="color: #B5A49A; font-size: 16px;">${conversionData.skip_fill_rate}%</strong><br/>`;
                                        html += `<span style="font-size: 11px; color: #909399;">ï¼ˆ${conversionData.never_filled_count}ä¸ªé¡¹ç›®åˆ°è¾¾åç»­é˜¶æ®µä½†æœªå¡«æŠ¥è¯¥é˜¶æ®µï¼‰</span>`;
                                        html += `</div>`;
                                    }
                                }

                                html += `</div>`;
                                return html;
                            }
                        },
                        series: [{
                            type: 'funnel',
                            left: '10%',
                            top: 80,
                            bottom: 80,
                            width: '80%',
                            sort: 'none',
                            gap: 2,
                            label: {
                                show: true,
                                position: 'inside',
                                formatter: (params) => {
                                    const stageIndex = params.dataIndex;
                                    const conversionData = this.conversionRates[stageIndex];

                                    // æœ€åä¸€ä¸ªé˜¶æ®µæ²¡æœ‰ä¸‹ä¸€é˜¶æ®µï¼Œä¸æ˜¾ç¤ºè½¬åŒ–ç‡
                                    if (!conversionData || stageIndex >= this.stageStatsFilled.length - 1) {
                                        return `${params.name}: ${params.value}`;
                                    }

                                    // è®¡ç®—è¡¥é½æ¨¡å¼çš„è½¬åŒ–ç‡ï¼šä¸‹ä¸€é˜¶æ®µæ•°é‡ / å½“å‰é˜¶æ®µæ•°é‡
                                    const currentStageValue = this.stageStatsFilled[stageIndex].value;
                                    const nextStageValue = this.stageStatsFilled[stageIndex + 1].value;
                                    const filledConversionRate = currentStageValue > 0
                                        ? Math.round(nextStageValue / currentStageValue * 1000) / 10
                                        : 0;

                                    // æ˜¾ç¤ºè¡¥é½æ¨¡å¼è½¬åŒ–ç‡å’Œè·³å¡«ç‡ï¼ˆå¦‚æœæœ‰ï¼‰
                                    let label = `${params.name}: ${params.value}\nâ†“ ${filledConversionRate}%`;
                                    if (conversionData.skip_fill_rate > 0) {
                                        label += `\n(è·³å¡«: ${conversionData.skip_fill_rate}%)`;
                                    }
                                    return label;
                                },
                                fontSize: 12,
                                lineHeight: 18,
                                color: '#fff',
                                fontWeight: '300'
                            },
                            itemStyle: {
                                borderColor: '#fff',
                                borderWidth: 1,
                                // æ ¹æ®æ˜¯å¦æœ‰è·³å¡«è®¾ç½®é¢œè‰²ï¼šæœ‰è·³å¡«=ç°è‰²ï¼Œæ— è·³å¡«=é’è‰²
                                color: (params) => {
                                    const stageIndex = params.dataIndex;
                                    const conversionData = this.conversionRates[stageIndex];
                                    const skipRate = conversionData?.skip_fill_rate || 0;

                                    if (skipRate > 0) {
                                        // æœ‰è·³å¡«ï¼šç°è‰²æ¸å˜
                                        return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            {offset: 0, color: '#A0AEC0'},
                                            {offset: 1, color: '#718096'}
                                        ]);
                                    } else {
                                        // æ— è·³å¡«ï¼šé’è‰²æ¸å˜
                                        return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                            {offset: 0, color: '#22D3EE'},
                                            {offset: 1, color: '#06B6D4'}
                                        ]);
                                    }
                                }
                            },
                            data: data
                        }]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                renderConversionChart() {
                    const chart = echarts.init(document.getElementById('conversionChart'));
                    const xData = this.conversionRates.map(item => `${item.from_stage}\nâ†’\n${item.to_stage}`);

                    // åŒé‡è½¬åŒ–ç‡æ•°æ®
                    const strictData = this.conversionRates.map(item => item.standard_conversion_rate);  // ä¸¥æ ¼æ¨¡å¼
                    const filledData = this.conversionRates.map(item => item.process_conversion_rate);   // è¡¥é½æ¨¡å¼

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {type: 'shadow'},
                            formatter: function (params) {
                                const index = params[0].dataIndex;
                                const data = this.conversionRates[index];

                                let html = `<div style="padding: 5px;">`;
                                html += `<strong style="font-size: 14px;">${data.from_stage} â†’ ${data.to_stage}</strong><br/><br/>`;

                                // åŸºç¡€æ•°æ®
                                html += `<div style="margin: 8px 0; color: #909399;">`;
                                html += `è¿›å…¥è¯¥é˜¶æ®µ: <strong>${data.entered_count}</strong> ä¸ªé¡¹ç›®<br/>`;
                                html += `å·²ç¦»å¼€è¯¥é˜¶æ®µ: <strong>${data.left_count}</strong> ä¸ªé¡¹ç›®<br/>`;
                                html += `è¿˜åœ¨è¯¥é˜¶æ®µ: <strong>${data.in_progress_count}</strong> ä¸ªé¡¹ç›®`;
                                html += `</div>`;

                                html += `<hr style="border: none; border-top: 1px dashed #ddd; margin: 10px 0;"/>`;

                                // ä¸¥æ ¼æ¨¡å¼è½¬åŒ–ç‡
                                html += `<div style="margin: 8px 0; padding: 8px; background: #E8F3F0; border-left: 3px solid #7DAEA3;">`;
                                html += `<span style="color: #7DAEA3;">ğŸ¯ ä¸¥æ ¼æ¨¡å¼è½¬åŒ–ç‡</span><br/>`;
                                html += `<span style="font-size: 11px; color: #909399;">ï¼ˆåªç»Ÿè®¡å®é™…å¡«æŠ¥è¯¥é˜¶æ®µçš„é¡¹ç›®ï¼‰</span><br/>`;
                                html += `ç›´æ¥æ¨è¿›: <strong>${data.direct_count}</strong> ä¸ª<br/>`;
                                html += `è½¬åŒ–ç‡: <strong style="color: #7DAEA3; font-size: 16px;">${data.standard_conversion_rate}%</strong>`;
                                html += `</div>`;

                                // è¡¥é½æ¨¡å¼è½¬åŒ–ç‡
                                html += `<div style="margin: 8px 0; padding: 8px; background: #EBF0F4; border-left: 3px solid #9DB4C0;">`;
                                html += `<span style="color: #8FA3B0;">ğŸ“Š è¡¥é½æ¨¡å¼è½¬åŒ–ç‡</span><br/>`;
                                html += `<span style="font-size: 11px; color: #909399;">ï¼ˆåˆ°è¾¾åç»­é˜¶æ®µç®—å®Œæˆè¯¥é˜¶æ®µï¼‰</span><br/>`;
                                html += `æ€»æ¨è¿›: <strong>${data.total_progressed}</strong> ä¸ª (${data.direct_count} ç›´æ¥ + ${data.skip_count} è·³é˜¶æ®µ)<br/>`;
                                html += `è½¬åŒ–ç‡: <strong style="color: #9DB4C0; font-size: 16px;">${data.process_conversion_rate}%</strong>`;
                                html += `</div>`;

                                // è·³å¡«æç¤º
                                if (data.skip_fill_rate > 0) {
                                    html += `<div style="margin: 8px 0; padding: 6px; background: #EEE8E5; border-left: 3px solid #C8B5B0;">`;
                                    html += `âš ï¸ è·³å¡«ç‡: <strong style="color: #B5A49A;">${data.skip_fill_rate}%</strong> `;
                                    html += `(${data.never_filled_count}ä¸ªé¡¹ç›®åˆ°è¾¾åç»­é˜¶æ®µä½†æœªå¡«æŠ¥è¯¥é˜¶æ®µ)`;
                                    html += `</div>`;
                                }

                                html += `</div>`;
                                return html;
                            }.bind(this)
                        },
                        legend: {
                            data: ['ä¸¥æ ¼æ¨¡å¼è½¬åŒ–ç‡', 'è¡¥é½æ¨¡å¼è½¬åŒ–ç‡'],
                            top: 10
                        },
                        xAxis: {
                            type: 'category',
                            data: xData,
                            axisLabel: {interval: 0, rotate: 0, fontSize: 10}
                        },
                        yAxis: {
                            type: 'value',
                            name: 'è½¬åŒ–ç‡(%)',
                            max: 100,
                            axisLabel: {formatter: '{value}%'}
                        },
                        series: [
                            {
                                name: 'ä¸¥æ ¼æ¨¡å¼è½¬åŒ–ç‡',
                                type: 'bar',
                                data: strictData,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#A8C5BA'},
                                        {offset: 1, color: '#7DAEA3'}
                                    ])
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: '{c}%',
                                    fontSize: 11,
                                    color: '#555',
                                    fontWeight: 'normal'
                                },
                                barWidth: '35%'
                            },
                            {
                                name: 'è¡¥é½æ¨¡å¼è½¬åŒ–ç‡',
                                type: 'line',
                                data: filledData,
                                itemStyle: {color: '#9DB4C0'},
                                lineStyle: {width: 3, type: 'dashed'},
                                symbol: 'circle',
                                symbolSize: 8,
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        const data = this.conversionRates[params.dataIndex];
                                        return data.in_progress_count > 0 ?
                                            `${params.value}% (${data.in_progress_count}åœ¨é€”)` :
                                            `${params.value}%`;
                                    }.bind(this),
                                    fontSize: 10,
                                    color: '#666',
                                    fontWeight: 'normal'
                                }
                            }
                        ]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                renderDurationChart() {
                    if (!this.stageDurationAnalysis || this.stageDurationAnalysis.length === 0) {
                        return;  // æ²¡æœ‰æ•°æ®æ—¶ä¸æ¸²æŸ“
                    }

                    const chart = echarts.init(document.getElementById('durationChart'));
                    const xData = this.stageDurationAnalysis.map(item => item.stage);
                    const medianData = this.stageDurationAnalysis.map(item => item.median_days);
                    const avgData = this.stageDurationAnalysis.map(item => item.avg_days);

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: function (params) {
                                const index = params[0].dataIndex;
                                const data = this.stageDurationAnalysis[index];

                                let html = `<div style="padding: 8px;">`;
                                html += `<strong style="font-size: 14px;">${data.stage}</strong><br/><br/>`;

                                if (data.sample_size > 0) {
                                    // æ˜¾ç¤ºä¸­ä½æ•°å’Œå¹³å‡å€¼
                                    html += `<div style="margin: 6px 0;">`
                                    html += `<span style="color: #1E3A8A;">â– </span> ä¸­ä½æ•°: <strong style="color: #1E3A8A; font-size: 16px;">${data.median_days}</strong> å¤©<br/>`;
                                    html += `<span style="color: #06B6D4;">â—</span> å¹³å‡å€¼: <strong style="color: #06B6D4; font-size: 16px;">${data.avg_days}</strong> å¤©`;
                                    html += `</div>`;

                                    html += `<hr style="border: none; border-top: 1px dashed #ddd; margin: 8px 0;"/>`;

                                    // æ˜¾ç¤ºæ ·æœ¬é‡
                                    html += `<div style="color: #606266;">`
                                    html += `æ ·æœ¬é‡: <strong>${data.sample_size}</strong> ä¸ªé¡¹ç›®<br/>`;
                                    html += `<span style="font-size: 11px; color: #909399;">ï¼ˆå®é™…å¡«æŠ¥è¿‡è¯¥é˜¶æ®µçš„é¡¹ç›®æ•°ï¼‰</span>`;
                                    html += `</div>`;

                                    // æ˜¾ç¤ºè·³è¿‡ç‡ï¼ˆå¦‚æœæœ‰ï¼‰
                                    if (data.skip_rate > 0) {
                                        html += `<hr style="border: none; border-top: 1px dashed #ddd; margin: 8px 0;"/>`;
                                        html += `<div style="padding: 6px; background: #EEE8E5; border-left: 3px solid #C8B5B0; margin-top: 6px;">`;
                                        html += `<span style="color: #B5A49A;">âš ï¸ è·³å¡«ç‡: <strong>${data.skip_rate}%</strong></span><br/>`;
                                        html += `<span style="font-size: 11px; color: #909399;">éƒ¨åˆ†é¡¹ç›®è·³è¿‡æ­¤é˜¶æ®µç›´æ¥åˆ°åç»­é˜¶æ®µ</span>`;
                                        html += `</div>`;
                                    }
                                } else {
                                    html += `<span style="color: #909399; font-style: italic;">æ— é¡¹ç›®å®é™…ç»å†æ­¤é˜¶æ®µ</span>`;
                                }

                                html += `</div>`;
                                return html;
                            }.bind(this)
                        },
                        legend: {
                            data: ['ä¸­ä½æ•°ï¼ˆæ›´å‡†ç¡®ï¼‰', 'å¹³å‡å€¼ï¼ˆå‚è€ƒï¼‰'],
                            top: 10
                        },
                        xAxis: {
                            type: 'category',
                            data: xData,
                            axisLabel: {
                                interval: 0,
                                rotate: 45,
                                fontSize: 11
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'åœç•™å¤©æ•°',
                            axisLabel: {
                                formatter: '{value} å¤©'
                            }
                        },
                        series: [
                            {
                                name: 'ä¸­ä½æ•°ï¼ˆæ›´å‡†ç¡®ï¼‰',
                                type: 'bar',
                                data: medianData,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#3B5BA5' },
                                        { offset: 1, color: '#1E3A8A' }
                                    ])
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        const data = this.stageDurationAnalysis[params.dataIndex];
                                        return data.sample_size > 0 ? `${params.value}å¤©` : 'N/A';
                                    }.bind(this),
                                    fontSize: 11,
                                    color: '#555',
                                    fontWeight: 'normal'
                                },
                                barWidth: '50%'
                            },
                            {
                                name: 'å¹³å‡å€¼ï¼ˆå‚è€ƒï¼‰',
                                type: 'line',
                                data: avgData,
                                itemStyle: { color: '#06B6D4' },
                                lineStyle: { width: 3, type: 'dashed' },
                                symbol: 'circle',
                                symbolSize: 8,
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        const data = this.stageDurationAnalysis[params.dataIndex];
                                        if (data.sample_size === 0) return '';
                                        // åªåœ¨å¹³å‡å€¼å’Œä¸­ä½æ•°å·®å¼‚è¾ƒå¤§æ—¶æ˜¾ç¤º
                                        if (Math.abs(data.avg_days - data.median_days) > data.median_days * 0.2) {
                                            return `${params.value}å¤©`;
                                        }
                                        return '';
                                    }.bind(this),
                                    fontSize: 10,
                                    color: '#666',
                                    fontWeight: 'normal'
                                }
                            }
                        ]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                renderTrendChart() {
                    const chart = echarts.init(document.getElementById('trendChart'));
                    const xData = this.monthlyTrend.map(item => item.month);
                    const yData = this.monthlyTrend.map(item => item.count);

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            formatter: '{b}: {c} ä¸ªé¡¹ç›®'
                        },
                        xAxis: {
                            type: 'category',
                            data: xData,
                            axisLabel: {
                                interval: 0,
                                rotate: 45
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'é¡¹ç›®æ•°'
                        },
                        series: [{
                            type: 'line',
                            data: yData,
                            smooth: true,
                            itemStyle: {
                                color: '#06B6D4'
                            },
                            areaStyle: {
                                color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
                                    offset: 0,
                                    color: 'rgba(6, 182, 212, 0.3)'
                                }, {
                                    offset: 1,
                                    color: 'rgba(6, 182, 212, 0.1)'
                                }])
                            },
                            label: {
                                show: true,
                                position: 'top',
                                color: '#555',
                                fontWeight: 'normal'
                            }
                        }]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                renderSkipFillChart() {
                    if (!this.skipFillStats || this.skipFillStats.length === 0) {
                        return;  // æ²¡æœ‰æ•°æ®æ—¶ä¸æ¸²æŸ“
                    }

                    const chart = echarts.init(document.getElementById('skipFillChart'));
                    const xData = this.skipFillStats.map(item => item.stage);
                    const skipRates = this.skipFillStats.map(item => item.skip_rate);

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            formatter: function (params) {
                                const index = params[0].dataIndex;
                                const data = this.skipFillStats[index];

                                let html = `<div style="padding: 5px;">`;
                                html += `<strong style="font-size: 14px;">${data.stage}</strong><br/><br/>`;
                                html += `åˆ°è¾¾åç»­é˜¶æ®µ: <strong>${data.reached_subsequent_count}</strong> ä¸ªé¡¹ç›®<br/>`;
                                html += `å¡«è¿‡è¯¥é˜¶æ®µ: <strong style="color: #7DAEA3;">${data.filled_count}</strong> ä¸ª<br/>`;
                                html += `è·³è¿‡/æ¼å¡«: <strong style="color: #1E3A8A;">${data.never_filled_count}</strong> ä¸ª<br/>`;
                                html += `<hr style="border: none; border-top: 1px dashed #ddd; margin: 8px 0;"/>`;
                                html += `è·³å¡«æ¯”ä¾‹: <strong style="color: #06B6D4; font-size: 16px;">${data.skip_rate}%</strong>`;
                                html += `</div>`;
                                return html;
                            }.bind(this)
                        },
                        xAxis: {
                            type: 'category',
                            data: xData,
                            axisLabel: {
                                interval: 0,
                                rotate: 45,
                                fontSize: 11
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'è·³å¡«æ¯”ä¾‹(%)',
                            max: 100,
                            axisLabel: {
                                formatter: '{value}%'
                            }
                        },
                        series: [{
                            type: 'bar',
                            data: skipRates,
                            itemStyle: {
                                color: function(params) {
                                    // æ ¹æ®è·³å¡«æ¯”ä¾‹è®¾ç½®é¢œè‰²
                                    const rate = params.value;
                                    if (rate > 50) return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#3B5BA5'},
                                        {offset: 1, color: '#1E3A8A'}
                                    ]);  // æ·±è“æ¸å˜ï¼šé«˜è·³å¡«ç‡
                                    if (rate > 20) return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#22D3EE'},
                                        {offset: 1, color: '#06B6D4'}
                                    ]);  // é’è‰²æ¸å˜ï¼šä¸­ç­‰è·³å¡«ç‡
                                    return new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        {offset: 0, color: '#A8C5BA'},
                                        {offset: 1, color: '#7DAEA3'}
                                    ]);  // ç°ç»¿æ¸å˜ï¼šä½è·³å¡«ç‡
                                }
                            },
                            label: {
                                show: true,
                                position: 'top',
                                formatter: '{c}%',
                                color: '#555',
                                fontWeight: 'normal'
                            }
                        }]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                renderPerformanceChart() {
                    if (!this.performanceData || this.performanceData.length === 0) {
                        return;  // æ²¡æœ‰æ•°æ®æ—¶ä¸æ¸²æŸ“
                    }

                    const chart = echarts.init(document.getElementById('performanceChart'));
                    const salesmanNames = this.performanceData.map(item => item.salesman_name);
                    const wonAmounts = this.performanceData.map(item => item.total_won_amount / 10000);  // è½¬æ¢ä¸ºä¸‡å…ƒ
                    const pipelineAmounts = this.performanceData.map(item => item.estimated_pipeline_amount / 10000);  // è½¬æ¢ä¸ºä¸‡å…ƒ
                    const wonRates = this.performanceData.map(item => item.won_rate);

                    const option = {
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: { type: 'shadow' },
                            formatter: function (params) {
                                const index = params[0].dataIndex;
                                const data = this.performanceData[index];

                                let html = `<div style="padding: 8px;">`;
                                html += `<strong style="font-size: 14px;">${data.salesman_name}</strong><br/><br/>`;

                                // èµ¢å•æ•°æ®
                                html += `<div style="margin: 6px 0; padding: 8px; background: #EBF5FF; border-left: 3px solid #1E3A8A;">`;
                                html += `<span style="color: #1E3A8A;">ğŸ’° èµ¢å•ä¸šç»©</span><br/>`;
                                html += `èµ¢å•é‡‘é¢: <strong style="color: #1E3A8A; font-size: 16px;">Â¥${this.formatAmount(data.total_won_amount)}</strong><br/>`;
                                html += `èµ¢å•æ•°é‡: <strong>${data.won_projects}</strong> ä¸ª<br/>`;
                                html += `å¹³å‡å•ä»·: <strong>Â¥${this.formatAmount(data.avg_won_amount)}</strong>`;
                                html += `</div>`;

                                // åœ¨é€”é¡¹ç›®
                                html += `<div style="margin: 6px 0; padding: 8px; background: #ECFEFF; border-left: 3px solid #06B6D4;">`;
                                html += `<span style="color: #06B6D4;">ğŸ“Š åœ¨é€”é¡¹ç›®</span><br/>`;
                                html += `åœ¨é€”é‡‘é¢: <strong style="color: #06B6D4; font-size: 16px;">Â¥${this.formatAmount(data.estimated_pipeline_amount)}</strong><br/>`;
                                html += `åœ¨é€”æ•°é‡: <strong>${data.active_projects}</strong> ä¸ª`;
                                html += `</div>`;

                                // æ•´ä½“ç»Ÿè®¡
                                html += `<div style="margin: 6px 0; padding: 8px; background: #E8F3F0; border-left: 3px solid #7DAEA3;">`;
                                html += `<span style="color: #7DAEA3;">ğŸ“ˆ æ•´ä½“è¡¨ç°</span><br/>`;
                                html += `æ€»é¡¹ç›®æ•°: <strong>${data.total_projects}</strong> ä¸ª<br/>`;
                                html += `èµ¢å•ç‡: <strong style="color: #7DAEA3; font-size: 16px;">${data.won_rate}%</strong><br/>`;
                                html += `å¤±å•æ•°: <strong>${data.lost_projects}</strong> ä¸ª`;
                                html += `</div>`;

                                html += `</div>`;
                                return html;
                            }.bind(this)
                        },
                        legend: {
                            data: ['èµ¢å•é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰', 'åœ¨é€”é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰', 'èµ¢å•ç‡ï¼ˆ%ï¼‰'],
                            top: 10
                        },
                        xAxis: {
                            type: 'category',
                            data: salesmanNames,
                            axisLabel: {
                                interval: 0,
                                rotate: 0,
                                fontSize: 12
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                                position: 'left',
                                axisLabel: {
                                    formatter: '{value}ä¸‡'
                                }
                            },
                            {
                                type: 'value',
                                name: 'èµ¢å•ç‡ï¼ˆ%ï¼‰',
                                position: 'right',
                                max: 100,
                                axisLabel: {
                                    formatter: '{value}%'
                                }
                            }
                        ],
                        series: [
                            {
                                name: 'èµ¢å•é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                                type: 'bar',
                                data: wonAmounts,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#3B5BA5' },
                                        { offset: 1, color: '#1E3A8A' }
                                    ])
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        return params.value > 0 ? `${params.value.toFixed(1)}ä¸‡` : '';
                                    },
                                    fontSize: 11,
                                    color: '#555',
                                    fontWeight: 'normal'
                                },
                                barWidth: '25%'
                            },
                            {
                                name: 'åœ¨é€”é‡‘é¢ï¼ˆä¸‡å…ƒï¼‰',
                                type: 'bar',
                                data: pipelineAmounts,
                                itemStyle: {
                                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                        { offset: 0, color: '#22D3EE' },
                                        { offset: 1, color: '#06B6D4' }
                                    ])
                                },
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: function(params) {
                                        return params.value > 0 ? `${params.value.toFixed(1)}ä¸‡` : '';
                                    },
                                    fontSize: 11,
                                    color: '#555',
                                    fontWeight: 'normal'
                                },
                                barWidth: '25%'
                            },
                            {
                                name: 'èµ¢å•ç‡ï¼ˆ%ï¼‰',
                                type: 'line',
                                yAxisIndex: 1,
                                data: wonRates,
                                itemStyle: { color: '#7DAEA3' },
                                lineStyle: { width: 3 },
                                symbol: 'circle',
                                symbolSize: 10,
                                label: {
                                    show: true,
                                    position: 'top',
                                    formatter: '{c}%',
                                    fontSize: 11,
                                    color: '#7DAEA3',
                                    fontWeight: 'bold'
                                }
                            }
                        ]
                    };

                    chart.setOption(option);
                    window.addEventListener('resize', () => chart.resize());
                },

                formatAmount(amount) {
                    return amount.toLocaleString('zh-CN', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 2
                    });
                }
            }
        });
    </script>
</body>

</html>
